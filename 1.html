<style>
    @import"https://fonts.googleapis.com/css2?family=PT+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap";@import"https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200;0,300;0,400;0,600;0,700;0,800;0,900;1,200;1,300;1,400;1,600;1,700;1,800;1,900&display=swap";@import"https://fonts.googleapis.com/css2?family=Lobster&display=swap";@import"https://fonts.googleapis.com/css2?family=Pacifico&display=swap";
    @import 'https://fonts.googleapis.com/css2?family=Caveat:wght@400;500;600;700&display=swap';
       /*kv - new */
       @import "https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;1,100;1,300;1,400;1,500;1,700&display=swap";
    </style>
    
    <style>
   @import"https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css";:root{--width: clamp(275px, calc(76vw - 2rem), 450px);--fz: clamp(18px, 2em, 26px);--bgc-blue: #bedfef;--fc-pink: hsl(299, 89%, 41%)}#form387249820 .mistake{display:none;text-align:center;font-size:max(1.6em, 14px);color:#98123d;margin-top:15px;font-weight:400;font-family:"Roboto",Arial,sans-serif}#form387249820 .mistake .inf-link{display:inline;text-decoration:underline;cursor:pointer}#our-demo{font-size:1vw;margin:1rem 0;max-width:1200px;margin:0 auto;font-family:"Roboto",Arial,sans-serif}#our-demo .d-none{display:none !important}#our-demo .shadow{position:fixed;top:0;bottom:0;left:0;right:0;opacity:1;background-color:#413737}#our-demo .page{margin:0 1rem}#our-demo .page,#our-demo .inner-page{display:none}#our-demo .page.active,#our-demo .inner-page.active{display:block}#our-demo .inner-page-1 :last-child{text-align:center;margin-top:.3rem}#our-demo body{font-size:1vw;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji"}#our-demo .continer{position:relative;max-width:1200px;padding:3rem 1rem;margin:0 auto;display:flex;align-items:center;justify-content:center}#our-demo .continer.hide{display:none}#our-demo h1{text-align:center;font-size:max(20px, 3em)}#our-demo label,#our-demo p{margin:0;font-size:max(2em, 18px)}#our-demo .page-1,#our-demo .page-2{width:min(75%, 510px)}#our-demo .page-1 .change-elem,#our-demo .page-2 .change-elem{margin:0;margin-bottom:1rem}#our-demo .page-1>p,#our-demo .page-2>p{text-align:center;margin:1rem 0}#our-demo .page-1 input,#our-demo .page-2 input{height:min(3rem, 2em)}#our-demo .form-1,#our-demo .page-2>div{display:grid;gap:.5rem}#our-demo .page-3 .title-container{font-size:max(20px, 3em);margin-bottom:.5rem}#our-demo .page-3 #title-1{text-align:center;margin:0;padding:1rem 0 .5rem 0;font-size:1em}#our-demo .page-3 .container-page-move{text-align:center;margin-bottom:1rem}#our-demo .page-3 .container-page-move .return{font-size:clamp(14px, 3.5vw, 24px);padding:.2rem 1rem;border-radius:10px}#our-demo #zoomRange{margin-left:.5rem;font-size:max(2em, 18px);width:4ch}#our-demo #cropModal .modal-body>:nth-child(2){display:flex;flex-direction:column}#our-demo #cropModal .modal-body>:nth-child(2) label{align-self:baseline}#our-demo .canvas-container{margin:0 auto;background-color:#fff}#our-demo #c,#our-demo .upper-canvas,#our-demo .canvas-container{border:1px solid #000;max-width:var(--width);max-height:calc(var(--width)*4/3);min-width:var(--width);min-height:calc(var(--width)*4/3)}#our-demo .wb-projects{display:none}#our-demo .wb-projects img{cursor:pointer}#our-demo .btn{font-weight:700;color:var(--fc-pink);background-color:var(--bgc-blue);border-radius:10px;padding:.5rem 2rem}#our-demo body{margin:0}#our-demo input{font-size:var(--fz);border:1px solid #000}#our-demo button{font-size:var(--fz)}#our-demo input:focus{border:2px solid green;border-radius:5px;outline:none}#our-demo input[type=checkbox]{width:auto !important;transform:scale(1.7)}#our-demo .container-checkbox{display:flex !important;align-items:center;gap:.5rem}#our-demo .templates{display:flex;overflow-x:auto;gap:.5rem;align-items:flex-start;min-height:106px}#our-demo .templates img{width:70px;cursor:pointer}#our-demo .save-canvas{position:absolute;top:0;right:0}#our-demo .save-canvas button{border-radius:0 0 0 10px;height:max(1.4em, 1.6rem);font-size:max(2em, 13px);background-color:gray;padding:0 .2rem}#our-demo .tool-btns{display:none;flex-direction:column;align-items:center;margin:0 auto;margin-bottom:1rem}#our-demo .tool-btns .title{margin-bottom:.5rem}#our-demo .tool-btns p:not(.title){display:none}#our-demo .tool-btns button{display:inline-flex;align-items:center;justify-content:center}#our-demo .tool-btns button:hover:active{outline:2px solid #77efff}@media(hover: hover){#our-demo .tool-btns button:hover{outline:2px solid #77efff}}#our-demo .tool-btns button:focus{outline:2px solid #77efff;box-shadow:none}#our-demo .tool-btns button.active{background-color:#2592c1}#our-demo .tool-btns #icons svg{transform:scale(1.4)}#our-demo .tool-btns>div{display:grid;justify-content:space-around;gap:.5rem;grid-template-areas:"one two three four five six";width:100%}#our-demo .tool-btns>div button{width:max(44px, 14vw);height:44px;padding:0}#our-demo .tool-btns>div button:nth-child(1){grid-area:one}#our-demo .tool-btns>div button:nth-child(2){grid-area:two}#our-demo .tool-btns>div button:nth-child(3){grid-area:three}#our-demo .tool-btns>div button:nth-child(4){grid-area:four}#our-demo .tool-btns>div button:nth-child(5){grid-area:five}#our-demo .tool-btns>div button:nth-child(6){grid-area:six}#our-demo .tool button:hover{outline:2px solid #77efff}#our-demo .tool button:focus{outline:2px solid #77efff;box-shadow:none}#our-demo .tool.icons{font-size:1rem}#our-demo .tool.icons .card+.card{margin-top:.5rem}#our-demo .tool.icons .card-header{background-color:var(--bgc-blue);cursor:pointer;padding:.5rem}#our-demo .tool.icons .card-content{padding-top:.5rem}#our-demo .tool.icons .card-content.show{padding:.2rem 0 1rem 0}#our-demo .tool.icons .icon-category{font-size:.5rem;display:inline-flex;flex-direction:column}#our-demo .tool.icons .icon-category select{font-size:1.5rem}#our-demo .tool.icons #iconPackList .list .row{display:flex;flex-wrap:wrap;gap:.5rem}#our-demo .tool.icons #iconPackList .list>p{margin:1rem 0}#our-demo .tool.icons #iconPackList img{width:clamp(125px, 20vw, 132px);height:clamp(125px, 20vw, 132px)}#our-demo .tool.icons #iconList .list .row{display:flex;flex-wrap:wrap;gap:0 .5rem}#our-demo .tool.icons #iconList img{width:clamp(88px, 20vw, 132px);height:clamp(88px, 20vw, 132px)}#our-demo .redactor{width:100%}#our-demo .redactor .tool{display:none}#our-demo .redactor .tool.active{display:flex;gap:.7rem;flex-direction:column;align-items:flex-start}#our-demo .redactor .tool.active.move{display:grid}#our-demo .redactor .tool.active.move .coords{margin-top:1rem;grid-column:span 2;display:grid;gap:1rem}#our-demo .redactor .tool.active.move .coords>div{display:flex;gap:.5rem;height:40px}#our-demo .redactor .tool.active.move .coords>div p{align-self:center}#our-demo .redactor .tool.active.move .coords>div input{width:max(23%, 6ch);font-size:var(--fz)}#our-demo .redactor .tool.text{font-size:10px}#our-demo .redactor .tool.text textarea{border:1px solid #000;resize:vertical;min-height:3rem;max-height:13rem;font-size:1.2rem;width:95%}#our-demo .redactor .tool.text #newTextContent{width:95%}#our-demo .redactor .tool.text #textContent{display:none}#our-demo .redactor .tool.text .text-content{width:100%;text-align:center}#our-demo .redactor .tool.text .text-content p{text-align:left;margin:1rem 0 .5rem 0}#our-demo .redactor .tool.text .text__options>div{display:flex;flex-wrap:wrap;gap:.2rem 1rem}#our-demo .redactor .tool.text .text__options>div label{display:flex;align-items:center;gap:.3rem}#our-demo .redactor .tool.text button{font-size:max(1.6em, 14px)}#our-demo .redactor .tool.text>div:nth-child(3){display:flex;flex-wrap:wrap}#our-demo .redactor .tool.text>div:nth-child(3) label{align-self:center}#our-demo .redactor .tool.text>div>label{margin-right:.5rem}#our-demo .redactor .tool.text .new-text-container{width:100%;display:flex;flex-direction:column;align-items:flex-start;gap:.5rem;margin-top:1rem}#our-demo .redactor .tool.move{align-items:center;grid-template-columns:75px 1fr}#our-demo .redactor .tool.move p{font-size:var(--fz)}#our-demo .redactor .tool.move input{width:max(30%, 6ch)}#our-demo .redactor .tool.move>div{display:flex}#our-demo .redactor .tool.image{overflow:hidden}#our-demo .redactor .tool.image #fileUpload{cursor:pointer;border:none}#our-demo .redactor .tool.image #fileUpload:hover{background-color:var(--bgc-blue)}#our-demo .redactor .tool.image div:nth-child(1){display:grid}#our-demo .redactor .tool.image div:nth-child(1) label{font-size:1rem;margin-bottom:.2rem}#our-demo .btns-number button{position:relative;margin-left:1rem;border-radius:50%;padding:0;width:40px;height:40px}#our-demo .btns-number button::after{content:"";position:absolute;background-color:var(--fc-pink);width:100%;height:5px;top:50%;left:0;transform:translateY(-50%)}#our-demo .btns-number button:focus{outline:none}#our-demo .btns-number button+button::before{content:"";position:absolute;background-color:var(--fc-pink);width:100%;height:5px;top:50%;left:0;transform:translateY(-50%) rotateZ(90deg)}#our-demo .desktop-content{display:flex;flex-direction:column;gap:.5rem}#our-demo .desktop-content .tool label,#our-demo .desktop-content .tool p,#our-demo .desktop-content .tool select,#our-demo .desktop-content .tool button{font-size:clamp(20px, 2vw, 26px)}#our-demo .accordion{display:flex;flex-direction:column;align-self:stretch}#our-demo .accordion .card .card-content{display:none}#our-demo .accordion .card .card-content.show{display:block}#our-demo #rec387249894{margin-bottom:2rem}#our-demo #imageCropModal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background-color:rgba(0,0,0,.6)}#our-demo #imageCropModal .container{background-color:#fff;padding:1rem;position:fixed;top:50%;left:50%;transform:translateX(-50%) translateY(-55%);border-radius:10px}#our-demo #imageCropModal .container .img-container{width:80vw;height:70vh;max-width:1000px;max-height:60vh}#our-demo #imageCropModal .container .modal-footer{margin-top:1rem;display:grid;gap:1rem}#our-demo #imageCropModal .container .modal-footer button{cursor:pointer}#our-demo #imageCropModal .cropper-point{width:15px;height:15px}#our-demo #imageCropModal .cropper-line{opacity:.4}#our-demo #imageCropModal .cropper-line.line-s,#our-demo #imageCropModal .cropper-line.line-n{height:10px}#our-demo #imageCropModal .cropper-line.line-w,#our-demo #imageCropModal .cropper-line.line-e{width:10px}@media screen and (min-width: 376px){#our-demo .templates{min-height:118px}#our-demo .templates img{width:80px}}@media screen and (min-width: 565px){#our-demo .templates{min-height:144px}#our-demo .templates img{width:100px}}@media screen and (min-width: 720px){#our-demo .redactor .tool.move{grid-template-columns:100px 1fr}#our-demo .tool-btns p:not(.title){display:block;font-size:.7em}#our-demo .tool-btns svg{margin-left:1rem}#our-demo .tool-btns>div{display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem;grid-template-areas:"two three four" "one five six"}#our-demo .tool-btns>div button{width:auto}#our-demo #imageCropModal .modal-footer{display:flex !important;justify-content:center;flex-direction:row-reverse}}@media screen and (min-width: 720px)and (min-width: 1100px){#our-demo .templates{min-height:172px}#our-demo .templates img{width:120px;height:160px}#our-demo .templates{flex-wrap:wrap;justify-content:center}#our-demo .desktop-content{flex-direction:row;gap:2rem}#our-demo .desktop-content .tool{position:sticky;top:10%}#our-demo #iconPackList img{width:clamp(100px, 9.3vw, 132px) !important;height:clamp(100px, 9.3vw, 132px) !important}#our-demo #iconList img{width:clamp(100px, 9.3vw, 132px) !important;height:clamp(100px, 9.3vw, 132px) !important}#our-demo .tool.image div:nth-child(1) label{font-size:1.2rem !important}}@media screen and (min-width: 720px)and (min-width: 1400px){#our-demo .wb-projects{display:flex;gap:.5rem;flex-direction:column;margin-right:1rem;padding-right:1rem;border-right:1px solid #000}#our-demo .wb-projects img{width:100px}#our-demo .page-1{width:33vw}#our-demo h1{font-size:3rem}#our-demo p,#our-demo label,#our-demo #zoomRange{font-size:1.6em}#our-demo #zoomRange{width:5ch}#our-demo #cropModal label input{transform:scale(1.4)}#our-demo .form-1{gap:1rem}#our-demo .form-1 *{font-size:2.1rem}#our-demo .--canvas{margin:0}}
    </style>
    
    <style>
    #rec387249670,
    #rec387249789,
    #rec387249820,
    #rec387249894{
        display: none;
    }
    </style>
    
    <div class="continer" id="our-demo">
        <section class="page page-2 active">
            <div class="mistake">
                <div>Такой товар и фото на Wildberries не найдено!<br>Впишите другой артикул, или <div class="inf-link" onclick="$('#our-demo #mainPhotoUpload').click()">загрузите фото</div> вручную.</div>
            </div>
            <div class="">
                <input type="file" id="mainPhotoUpload" class="d-none" accept="image/jpeg, image/png">
            </div>
        </section>
        <section class="page page-3">
            <div class="title-container">
                <div id="title-1" class="title">Выберете шаблон</div>
            </div>
    
            <div class="desktop-content">
                <section class="--canvas">
                    <div class="canvas">
                        <canvas id="c" width="900" height="1200"></canvas>
                    </div>
                </section>
    
                <section class="inner-page inner-page-1 active">
                    <div class="container-page-move d-none">
                        <button class="btn return" onclick="returnToWbForm()">Загрузить фото</button>
                    </div>
    
                    <div class="templates">
                        <img data-template-id='1' src="http://stage.infograffer.ru/templates/254/cover.jpg">
                        <img data-template-id='2' src="http://stage.infograffer.ru/templates/68/cover.jpg">
                        <img data-template-id='3' src="http://stage.infograffer.ru/templates/14/cover.jpg">
                        <img data-template-id='4' src="http://stage.infograffer.ru/templates/62/cover.jpg">
                        <img data-template-id='5' src="http://stage.infograffer.ru/templates/1005/cover.jpg">
                        <img data-template-id='6' src="http://stage.infograffer.ru/templates/3/cover.jpg">
                        <img data-template-id='7' src="http://stage.infograffer.ru/templates/247/cover.jpg">
                        <img data-template-id='8' src="http://stage.infograffer.ru/templates/258/cover.jpg">
                        <img data-template-id='9' src="http://stage.infograffer.ru/templates/63/cover.jpg">
                        <img data-template-id='10' src="http://stage.infograffer.ru/templates/60/cover.jpg">
                    </div>
    
                    <div class="">
                        <button class="btn" onclick="openPage('.inner-page', innerPage += 1);">Далее</button>
                    </div>
                </section>
    
                <section class="inner-page inner-page-2 redactor">
                    <div class="tool-btns">
                        <p class="title">Инструменты:</p>
                        <div class="">
                            <button title="Назад" class="btn tool-btns__item return" type="button">
                                <p>назад</p>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                    class="bi bi-arrow-return-left" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd"
                                        d="M14.5 1.5a.5.5 0 0 1 .5.5v4.8a2.5 2.5 0 0 1-2.5 2.5H2.707l3.347 3.346a.5.5 0 0 1-.708.708l-4.2-4.2a.5.5 0 0 1 0-.708l4-4a.5.5 0 1 1 .708.708L2.707 8.3H12.5A1.5 1.5 0 0 0 14 6.8V2a.5.5 0 0 1 .5-.5z" />
                                </svg>
                            </button>
                            <button id="move" title="Положение" class="btn tool-btns__item" type="button">
                                <p>положение</p>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                    class="bi bi-arrows-move" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd"
                                        d="M7.646.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 1.707V5.5a.5.5 0 0 1-1 0V1.707L6.354 2.854a.5.5 0 1 1-.708-.708l2-2zM8 10a.5.5 0 0 1 .5.5v3.793l1.146-1.147a.5.5 0 0 1 .708.708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 0 1 .708-.708L7.5 14.293V10.5A.5.5 0 0 1 8 10zM.146 8.354a.5.5 0 0 1 0-.708l2-2a.5.5 0 1 1 .708.708L1.707 7.5H5.5a.5.5 0 0 1 0 1H1.707l1.147 1.146a.5.5 0 0 1-.708.708l-2-2zM10 8a.5.5 0 0 1 .5-.5h3.793l-1.147-1.146a.5.5 0 0 1 .708-.708l2 2a.5.5 0 0 1 0 .708l-2 2a.5.5 0 0 1-.708-.708L14.293 8.5H10.5A.5.5 0 0 1 10 8z" />
                                </svg>
                            </button>
                            <button id="text" title="Текст" class="btn tool-btns__item btn-sm" type="button">
                                <p>текст</p>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                    class="bi bi-cursor-text" viewBox="0 0 16 16">
                                    <path
                                        d="M5 2a.5.5 0 0 1 .5-.5c.862 0 1.573.287 2.06.566.174.099.321.198.44.286.119-.088.266-.187.44-.286A4.165 4.165 0 0 1 10.5 1.5a.5.5 0 0 1 0 1c-.638 0-1.177.213-1.564.434a3.49 3.49 0 0 0-.436.294V7.5H9a.5.5 0 0 1 0 1h-.5v4.272c.1.08.248.187.436.294.387.221.926.434 1.564.434a.5.5 0 0 1 0 1 4.165 4.165 0 0 1-2.06-.566A4.561 4.561 0 0 1 8 13.65a4.561 4.561 0 0 1-.44.285 4.165 4.165 0 0 1-2.06.566.5.5 0 0 1 0-1c.638 0 1.177-.213 1.564-.434.188-.107.335-.214.436-.294V8.5H7a.5.5 0 0 1 0-1h.5V3.228a3.49 3.49 0 0 0-.436-.294A3.166 3.166 0 0 0 5.5 2.5.5.5 0 0 1 5 2zm3.352 1.355zm-.704 9.29z" />
                                </svg>
                            </button>
    
                            <button id="icons" title="Иконки" class="btn tool-btns__item" type="button">
                                <p>иконки</p>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                    class="bi bi-info" viewBox="0 0 16 16">
                                    <path
                                        d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z" />
                                </svg>
                            </button>
    
                            <button id="image" title="Изображения" class="btn tool-btns__item" type="button">
                                <p>фото</p>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-card-image" viewBox="0 0 16 16">
                                    <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                                    <path d="M1.5 2A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h13a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-13zm13 1a.5.5 0 0 1 .5.5v6l-3.775-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12v.54A.505.505 0 0 1 1 12.5v-9a.5.5 0 0 1 .5-.5h13z"/>
                                </svg>
                            </button>
    
                            <button title="Сохранить" class="btn tool-btns__item save" type="button"
                                onclick="downloadImage('png')">
                                <p>сохранить</p>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                    class="bi bi-download" viewBox="0 0 16 16">
                                    <path
                                        d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z" />
                                    <path
                                        d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z" />
                                </svg>
                            </button>
                        </div>
                    </div>
    
                    <div class="tool text" id="toolText">
                        <div class="text-content">
                            <p>Текст активного элемента:</p>
                            <textarea id="textContent"></textarea>
                        </div>
                        <div>
                            <label class="form-label">Шрифт</label>
                            <select class="form-select text-font-family" id="textFontFamily"
                                oninput="changeText('fontFamily',$(this).val())">
                                <option value="PT Sans" style="font-family:'PT Sans'">PT Sans</option>
                                <option value="Nunito" style="font-family:'Nunito'">Nunito</option>
                                <option value="Lobster" style="font-family:'Lobster'">Lobster</option>
                                <option value="Pacifico" style="font-family:'Pacifico'">Pacifico</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Размер шрифта</label>
                            <input type="number" id="textFontSize" min="8" max="100" value="40" step="1"
                                oninput="changeText('fontSize',$(this).val())" class="form-select">
                            <div class="btns-number">
                                <button name="minus-fz" class="btn"></button>
                                <button name="plus-fz" class="btn"></button>
                            </div>
                        </div>
                        <div>
                            <label class="form-label">Цвет шрифта</label>
                            <input type="color" id="textColor" oninput="changeText('fill',$(this).val())">
                        </div>
                        <div class="text__options">
                            <p>Стиль:</p>
                            <div class="">
                                <label class="form-label">
                                    <input type="checkbox" id="textBold" name="text[font_style]"
                                        onchange="changeText('fontWeight',$(this).is(':checked') ? 'bold' : '')">Жирный
                                </label>
                                <label class="form-label">
                                    <input type="checkbox" id="textItalic" name="text[font_style]"
                                        onchange="changeText('fontStyle',$(this).is(':checked') ? 'italic' : '')">Курсив
                                </label>
                                <label class="form-label"><input type="checkbox" id="textUnderline" name="text[font_style]"
                                        onchange="changeText('underline',$(this).is(':checked') ? true : false)">Подчёркнутый
                                </label>
                                <label class="form-label">
                                    <input type="checkbox" id="textLineThrough" name="text[font_style]"
                                        onchange="changeText('linethrough',$(this).is(':checked') ? true : false)">Зачёркнутый
                                </label>
                            </div>
                        </div>
    
                        <div class="new-text-container">
                            <p>Добавить новый текст</p>
                            <textarea id="newTextContent"></textarea>
                            <button type="button" onclick="addText()" class="btn btn-primary">Добавить текст</button>
                        </div>
                    </div>
    
                    <div class="tool icons">
                        <div class="accordion">
                            <div class="card">
                                <div class="card-header icon-category-header">
                                    1. Выбор категории иконок
                                </div>
                                <div class="card-content show">
                                    <div class="icon-category">
                                        <label>Выберите категорию иконок:</label>
                                        <select>
                                            <option value="" selected>Выберите категорию</option>
                                            <option value="7">Стрелки</option>
                                            <option value="39">Новый Год</option>
                                            <option value="40">Торговля</option>
                                            <option value="23">Мода</option>
                                            <option value="85">Флаги</option>
                                            <option value="12">Погода</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header iconPackList-header">
                                    2. Выберите пакет иконок
                                </div>
                                <div class="card-content">
                                    <div class="" id="iconPackList">
                                        <div class="list">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header iconList-header">
                                    3. Иконки
                                </div>
                                <div class="card-content">
                                    <div id="iconList">
                                        <div class="list">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
    
                    <div class="tool move">
                        <p class="mt-2">Ширина</p>
                        <div class="">
                            <input id="objectWidth" type="number" min="0">
                            <div class="btns-number">
                                <button name="minus-w" class="btn"></button>
                                <button name="plus-w" class="btn"></button>
                            </div>
                        </div>
                        <p class="mt-2">Высота</p>
                        <div class="">
                            <input id="objectHeight" type="number" min="0">
                            <div class="btns-number">
                                <button name="minus-h" class="btn"></button>
                                <button name="plus-h" class="btn"></button>
                            </div>
                        </div>
                        <div class="container-checkbox">
                            <label for="proportion">Пропорция</label>
                            <input id="proportion" type="checkbox">
                        </div>
                        <div class="coords">
                            <div class="">
                                <p class="mt-2">Координаты X</p>
                                <input id="coordX" type="number" value="0" disabled>
                            </div>
                            <div class="">
                                <p class="mt-2">Координаты Y</p>
                                <input id="coordY" type="number" value="0" disabled>
                            </div>
                        </div>
                    </div>
    
                    <div class="tool image">
                        <div>
                            <label for="fileUpload" class="form-label">Загрузите новое изображение</label>
                            <input type="file" id="fileUpload" class="upload" name="userfile" accept="image/jpeg, image/png, image/gif, image/svg">
                        </div>
                        <div class="image-border-circle">
                            <label for="imageBorderCircle">Круглое изображение</label>
                            <input type="checkbox" id="imageBorderCircle" value="-1">
                        </div>
                    </div>
                </section>
            </div>
        </section>
    
        <div class="modal" id="imageCropModal" tabindex="-1">
            <div class="container">
                <div class="img-container">
                    <img id="imageCrop" src="#" width="100%" alt="Picture">
                </div>
                <div class="modal-footer">
                    <button type="button" id="applyCrop" class="btn" data-dismiss="modal">Применить</button>
                    <button type="button" class="btn" data-dismiss="modal">Закрыть</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ________________________________ -->
    <script src="https://unpkg.com/fabric@4.6.0/dist/fabric.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js" integrity="sha512-ooSWpxJsiXe6t4+PPjCgYmVfr1NS5QXJACcR/FPpsdm6kqG1FmQ2SVyg2RXeVuCRBLr0lWHnWJP6Zs1Efvxzww==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/webfont/1.6.28/webfontloader.js"
        integrity="sha512-v/wOVTkoU7mXEJC3hXnw9AA6v32qzpknvuUF6J2Lbkasxaxn2nYcl+HGB7fr/kChGfCqubVr1n2sq1UFu3Gh1w=="
        crossorigin="anonymous" referrerpolicy="no-referrer">
    
    </script>
    
    <script>
        let templates = null;
    
        $.ajax({
            url: 'https://stage.infograffer.ru/editor/export/templates/1/templates.json',
            success: function (data) {
                templates = data;
            },
            error: function () {
                console.warn('Ошибка получения json шаблонов!');
    
            }
        })
    
        // kv - new//
        ///////////////Показываем стартовые блоки -- точка входа пользователя//////////
        function showStartBlock() {
            $('#rec387249670,#rec387249789').css({
                display: 'block'
            });
        }
    </script>
    
    <script>
        let ajax_modal = $('#ajaxModal');
    
        fabric = (function (f) {
            var dblClickSubscribers = [];
            var nativeCanvas = f.Canvas;
            f.Canvas = (function (domId, options) {
                var canvasDomElement = document.getElementById(domId);
                var c = new nativeCanvas(domId, options);
                c.dblclick = function (handler) {
                    dblClickSubscribers.push(handler)
                };
                canvasDomElement.nextSibling.ondblclick = function (ev) {
                    for (var i = 0; i < dblClickSubscribers.length; i++) {
                        dblClickSubscribers[i]({
                            e: ev
                        });
                    }
                };
                return c;
            });
            return f;
        }(fabric));

        fabric.Object.prototype.borderColor = 'red';
        fabric.Object.prototype.borderScaleFactor = 2;
        fabric.Object.prototype.borderOpacityWhenMoving = 0.2;
        fabric.Object.prototype.cornerColor = 'green';
        fabric.Object.prototype.cornerSize = 30;
        fabric.Object.prototype.transparentCorners = false;
    
        const canvas = this.__canvas = new fabric.Canvas('c');
        let ctx = canvas.getContext('2d');
        canvas.set({
            preserveObjectStacking: true,
        });
    
    
        function setScale(value) {
            if (value == "0.5") {
                document.documentElement.style.cssText = "--width: 450px";
            } else if (value == '0.75') {
                document.documentElement.style.cssText = "--width: 675px";
            } else if (value == '1') {
                document.documentElement.style.cssText = "--width: 900px";
            } else if (value === 'smart') {
                document.documentElement.style.cssText = "min(calc(80vw - 2rem), 900px)";
            }
        }
    
        let targetImage = null;
    
        canvas.on('mouse:up', function (opt) {
            let obj = opt.target;
            targetImage = null;
            $('#our-demo #imageBorderCircle').prop('checked', false);
            $('#our-demo .redactor .image .image-border-circle').show();
            $('#our-demo label[for="fileUpload"]').text('Загрузите новое изображение');
    
            if (obj) {
                setObjCoords(obj.left, obj.top);
                obj.on('scaling',function(){
                    setObjCoords(obj.left, obj.top);
                });
                obj.on('moving',function(){
                    setObjCoords(obj.left, obj.top);
                });
    
                function text(obj) {
                    if (obj.type == 'textbox' || obj.type == 'i-text' || obj.type == 'text') {
                        $('#textContent').show();
                        $('button#text').click();
                    }
                }
                function image(_obj){
                    if (_obj.type == 'image') {
                        targetImage = _obj;
    
                        $('button#move').click();
                        $('#imageBorderCircle').prop('checked', (_obj.clipPath && _obj.clipPath.type === 'circle')?true:false);
                        $('#our-demo label[for="fileUpload"]').text('Заменить изображение');
                    }
                }
    
                if (obj.type === 'group') {
                    $('#our-demo .redactor .image .image-border-circle').hide();
                    findInnerElems(obj, text);
                    findInnerElems(obj, image);
                } else {
                    text(obj);
                    image(obj);
                }
            } else {
                $('#textContent').hide();
                $('#newTextContent').val('');
            }
        });
    
    
        
    
        let cropImg = document.getElementById('cropImage');
            let page = 3;
            let mainFoto = null;
            let innerPage = mainFoto == null ? 1 : 2;
            let x = true;
            const fontsMas = [
                'PT Sans',
                'Nunito',
                'Lobster',
                'Pacifico',
            ];
            const uid = Date.now().toString(36) + Math.random().toString(36).substr(2);
    
    
            $(document).ready(function () {
                preLoadFonts();
                openPage('.page', page);
                openPage('.inner-page', innerPage);
            });
    
            function openPage(selector, number, flag=false) {
                function closeAll() {
                    document.querySelectorAll(`${selector}.active`).forEach(item => {
                        item.classList.remove('active');
                    });
                }
                closeAll();
    
                document.querySelector(`${selector}-${number}`).classList.add('active');
    
                if (selector === '.page') {
                    if (number === 3) {
                        $('.container-page-move').removeClass('d-none');
                    }else{
                        $('.container-page-move').addClass('d-none');
                    }
                }
    
                if (flag) {
                    $('.page-2 .hide-elem').hide();
                    $('.page-2 .change-elem').text('Загрузите фотографию');
                }
    
    
                if (selector === '.inner-page') {
                    switch (number) {
                        case 1:
                            $('#title-1').text('Выберете шаблон');
                            $('.container-page-move .next-inner-page').attr('disabled', false);
                            $('.save-canvas').addClass('d-none');
                            $('.tool-btns').css('display', 'none');
                            break;
                        case 2:
                            $('.tool-btns').css('display', 'flex');
                            $('#title-1').text('Измените шаблон');
                            $('.container-page-move .next-inner-page').attr('disabled', true);
                            $('.save-canvas').removeClass('d-none');
                            break;
    
                        default:
                            break;
                    }
                }
            }
    
            //переключение страниц
            document.querySelectorAll('.next-page').forEach(item => {
                item.addEventListener('click', function (event) {
                    openPage('.page', page += 1);
                });
            });
    
            document.querySelectorAll('.next-inner-page').forEach(item => {
                item.addEventListener('click', function (event) {
                    openPage('.inner-page', innerPage += 1);
                });
            });
    
            $('.redactor .tools button').on('click', function () {
                const el = $('.redactor .tools button.active')[0];
    
                if (el != $(this)[0]) {
                    el.classList.remove('active');
                    $(this).addClass('active');
                }
            });
    
            function loadWBPhoto(acticul) {
                const articulPart = acticul.substr(0, acticul.length - 4);
                const url = 'https://images.wbstatic.net/big/new/' + articulPart + '0000/' + acticul + '-1.jpg';
                $.ajax({
                    url: url,
                    success: function (resp) {
                        $('#rec387249820').hide();
                        $('#rec387249894').show();
                        $('#form387249820 .mistake').hide();
                        $('.container-page-move').removeClass('d-none');
                        scrollToCanvas();
    
                        fabric.Image.fromURL(url, function (img) {
                            img.set({
                                top: canvas.height/2 - img.height*img.scaleY/2,
                                left: canvas.width/2 - img.width*img.scaleX/2,
                                ownType: 'mainFoto',
                            });
                            canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
                            mainFoto = fabric.util.object.clone(img);
                        }, {
                            crossOrigin: 'anonymous',
                        });
                    },
                    error: function (jqXHR, exception) {
                        $('#form387249820 .mistake').show();
                        findProblem(jqXHR, exception)
                    }
                })
            }
    
            function findProblem(jqXHR, exception){
                let errMsg = '';
                            let text = 'Произошла ошибка!';
    
                            if (jqXHR.status === 0) {
                                text += `\nОшибка: Not connect. Verify Network`
                                errMsg+= 'error>> Not connect. Verify Network';
                            } else if (jqXHR.status == 404) {
                                text += `\nОшибка: Requested page not found (404)`;
                                errMsg+= 'error>> Requested page not found (404)';
                            } else if (jqXHR.status == 500) {
                                text += `\nОшибка: Internal Server Error (500)`;
                                errMsg+= 'error>> Internal Server Error (500)';
                            } else if (exception === 'parsererror') {
                                text += `\nОшибка: Requested JSON parse failed`;
                                errMsg+= 'error>> Requested JSON parse failed';
                            } else if (exception === 'timeout') {
                                text += `\nОшибка: Time out error`;
                                errMsg+= 'error>> Time out error';
                            } else if (exception === 'abort') {
                                text += `\nОшибка: Ajax request aborted`;
                                errMsg+= 'error>> Ajax request aborted';
                            } else {
                                text += `\nОшибка: Uncaught Error\n${jqXHR.responseText}`;
                                errMsg+= 'error>> Uncaught Error' + jqXHR.responseText;
                            }
    
                            text += `\nПожалуйста, перезагрузите страницу. Если ошибка повториться, напишите нам в чат`;
                            alert(text);
                            throw errMsg;
            }
    
            function downloadImage(ext) {
                try {
                    canvas.backgroundColor = '#ffffff';
                    canvas.requestRenderAll();
    
                    $.ajax({
                        url: 'https://stage.infograffer.ru/editor/export/templates/1/sign.png',
                        xhrFields: {
                            responseType: 'blob'
                        },
                        success: function (data) {
                            let url = URL.createObjectURL(data);
                            fabric.Image.fromURL(url, function (img) {
                                img.set({
                                    left: 0,
                                    top: 0,
                                    opacity: 0.2,
                                });
                                canvas.add(img);
    
                                try {
                                    const base64 = canvas.toDataURL({
                                        format: 'jpeg',
                                        enableRetinaScaling: true,
                                        multiplier: 0.2,
                                    });
                                    
                                    let time = getCurrentTime();
    
                                    const link = document.createElement("a");
                                    link.href = base64;
                                    link.download = `infograffer-${time}.${ext}`;
                                    link.click();
                                } catch (error) {
                                    canvas.remove(img);
                                    canvas.renderAll();
                                }
    
    
    
                                canvas.remove(img);
                                canvas.renderAll();
    
                            });
                        },
                        error: function (jqXHR, exception) {
                            findProblem(jqXHR, exception)
                        }
                    });
    
    
                } catch (error) {
                    console.error('error >>> ', error);
                }
            }
    
            function getCurrentTime(){
                let currentDate = new Date();
                return ((currentDate.getMonth() + 1) + '-' + currentDate.getDate() + '-' + currentDate.getHours() + '-' + currentDate.getMinutes() + '-' + currentDate.getSeconds());
            }
    
            function closeAll(selector, classValue) {
                document.querySelectorAll(selector).forEach(item => {
                    item.classList.remove(classValue);
                });
            }
    
            function openOptions(value) {
                closeAll('.redactor .tool.active', 'active');
                $(`.redactor .tool.${value}`).addClass('active');
            }
    
            $('.tool-btns button').on('click', function () {
                if ($(this).hasClass('active') || $(this).hasClass('save') || $(this).hasClass('return')) {
                    return;
                };
    
                closeAll('.tool-btns button.active', 'active');
    
                $(this).addClass('active');
                openOptions($(this).attr('id'));
            });
    
            $('.tool-btns button.return').on('click',function(){
                openPage('.inner-page', innerPage -= 1);
            });
    
            function addText() {
                if (!$('#newTextContent').val()) {
                    return;
                }
    
                if (selectedGroup?.length) {
                    groupUpElements();
                }
    
                let text = new fabric.IText("Текст", {
                    left: 100,
                    top: 100,
                    padding: 10,
                    text: $('#newTextContent').val()?$('#newTextContent').val(): 'текст',
                    textBackgroundColor: 'transparent',
                    fontSize: $('#textFontSize').val(),
                    fontFamily: $('#textFontFamily').val()?$('#textFontFamily').val(): 'PT Sans',
                    fill: $('#textColor').val(),
                    objectCaching: false,
    
                    fontWeight: $('#textBold').is(':checked') ? 'bold' : '',
                    linethrough: $('#textLineThrough').is(':checked') ? true : false,
                    underline: $('#textUnderline').is(':checked') ? true : false,
                    fontStyle: $('#textItalic').is(':checked') ? 'italic' : '',
                });
    
                text.set({
                    left: canvas.width/2 - text.width/2,
                    top: canvas.height/2 - text.height/2,
                });
    
                canvas.add(text);
                canvas.setActiveObject(text);
                canvas.renderAll();
                activeTarget = text;
                textTarget = text;
                updateTextOptions(text);

                updateModifications();
    
                $('#textContent').show();
                $('#newTextContent').val('');
            }
    
            function removeInnerStyle(obj, attr) {
                if (!attr || !obj || !obj.styles[0] || !Object.keys(obj.styles[0]).length) {
                    return;
                }
    
                const clear = function (_this, key) {
                    if (!Object.keys(_this).length) {
                        delete obj.styles[0][key];
                    }
                }
    
                $.each(obj.styles[0], function (key) {
                    if ($(this)[0][attr] || $(this)[0][attr] === '') {
                        delete $(this)[0][attr];
                        clear($(this)[0], key);
                    }
                });
            }
    
            function findInnerElems(obj, cb){
                if (obj?._objects && (obj?.type === 'group' || obj?.type === 'activeSelection')) {
                    obj._objects.forEach(el => {
                        return findInnerElems(el, cb);
                    });
                } else {
                    cb(obj);
                }
            }
    
            function changeText(attribute, value) {
                const start = (object) => {
                    if (object ?.type === 'textbox' ||
                        object ?.type === 'i-text' ||
                        object ?.type === 'text') {
                        if (object ?.setSelectionStyles && object ?.isEditing) {
                            let style = {};
                            style[attribute] = value;
                            object.setSelectionStyles(style);
                            object.setCoords();
                        } else {
                            removeInnerStyle(object, attribute);
                            object.set(attribute, value);
                        }
                        canvas.renderAll();                        
                        $('#objectWidth').val((obj.width*obj.scaleX).toFixed());
                        $('#objectHeight').val((obj.height*obj.scaleY).toFixed());
                    }
                };
    
                let obj = canvas.getActiveObject();
                if (obj) {
                    findInnerElems(obj, start);
                    if (obj.type === 'group') {
                        obj.addWithUpdate();
                    }
                }
            }
    
            //для предварительной прогрузки шрифтов
            function preLoadFonts() {
                fontsMas.forEach((font) => {
                    canvas.add(new fabric.Textbox("тест", {
                        fill: '#000',
                        fontFamily: font,
                    }));
                    canvas.requestRenderAll();
                });
    
                canvas.forEachObject(function (object) {
                    if (object.ownType !== 'mainFoto') {
                        canvas.remove(object);
                    }
                });
                canvas.setBackgroundColor('');
                canvas.requestRenderAll();
                
                fabric.Object.prototype.hasControls = false;
            }
    
            $('.tool.icons .accordion .card-header').on('click', function(){
                let _this = $(this);
                $('.tool.icons .accordion .card-content').each(function(){
                    if ($(this)[0] !== _this.next()[0]){
                        $(this).slideUp();
                    }
                });
    
                $(this).next().slideToggle();
            });
    
            $('.icon-category select').on('change', function () {
                let id_category = $(this).val();
                if (id_category <= 0) {
                    return;
                }
    
                $.ajax('https://stage.infograffer.ru/icon/packs/?id_category=' + id_category, {
                    dataType: 'json',
                    beforeSend: function () {
    
                    },
                    success: function (packs) {
                        $('#iconPackList .list').html(packs);
                        $('.accordion .iconPackList-header').click();
                        $('#iconPackList > div > p > i').append($('#iconPackList > div > select'));
                    },
                    error: function (jqXHR, exception) {
                        findProblem(jqXHR, exception)
                    }
                });
            });
    
            $('#iconPackList').on('click', '[data-id_pack]', function () {
                let id_pack = $(this).data('id_pack');
    
                if (id_pack > 0) {
                    $.ajax('https://stage.infograffer.ru/icon/icons/?id_pack=' + id_pack, {
                        dataType: 'json',
                        beforeSend: function () {
    
                        },
                        success: function (icons) {
                            $('#iconList .list').html(icons);
                            $('.accordion .iconList-header').click();
                            $('#iconList .list p, #iconList .list select').hide();
                        },
                        error: function (jqXHR, exception) {
                            findProblem(jqXHR, exception)
                        }
                    });
                }
            });
    
            $('#iconPackList').on('click', 'a[href="#"]', function(e){
                e.preventDefault();
            });
    
    
            $('#iconPackList').on('change', '[name="packs_page"]', function () {
                let id_category = $(this).data('id_category');
                let page = $(this).val();
    
                $.ajax('https://stage.infograffer.ru/icon/packs/?id_category=' + id_category + '&page=' + page, {
                    dataType: 'json',
                    beforeSend: function () {
    
                    },
                    success: function (packs) {
                        $('#iconPackList .list').html(packs);
                        $('#iconPackList > div > p > i').append($('#iconPackList > div > select'));
                    },
                    error: function (jqXHR, exception) {
                        findProblem(jqXHR, exception)
                    }
                })
            })
    
            $('#iconList').on('click', '.add-icon', function () {
                let url = $(this).attr('src');
                fabric.Image.fromURL(url, function (img) {
                    img.set({
                        left: 10,
                        top: 10,
                        ownType: 'icon',
                    });
                    img.scale(0.3);
                    img.set({
                        left: canvas.width/2 - img.width*img.scaleX/2,
                        top: canvas.height/2 - img.height*img.scaleY/2,
                    })
                    canvas.add(img);
                    updateModifications();
                }, {
                crossOrigin: 'anonymous',
                });
            });
    
            $('.templates').on('click', 'img', function () {
                let id_template = $(this).data('template-id');
    
                if (id_template>0) {
                    templates[id_template].backgroundImage = mainFoto;
                    templates[id_template].backgroundColor = '#fff';
                    canvas.loadFromJSON(templates[id_template], function(){
                        canvas.renderAll();
                        updateModifications();
                    });
                }
            });
    
    
            let doubleClicked = {
                flag: false,
                target: null,
            };
            let selectedGroup = [];
            let masForGroupUp = [];
            let is_edit_group = false;
            let activeTarget = null;
            let textTarget = null;
            
            function updateTextOptions(obj){
                    $('#textContent').val(obj.text);
                    $('#textFontFamily').val(obj.fontFamily);
                    $('#textFontSize').val(obj.fontSize);
                    $('#textColor').val(obj.fill);
                    $('#textBold').prop('checked',(obj.fontWeight > 500 || obj.fontWeight === 'bold')?true:false);
                    $('#textItalic').prop('checked',obj.fontStyle==='italic'?true:false);
                    $('#textUnderline').prop('checked',obj.underline?true:false);
                    $('#textLineThrough').prop('checked',obj.linethrough?true:false);
            }
    
            canvas.on("mouse:up",function(e){
                $('#textContent').val('');
                $('#objectWidth').val('');
                $('#objectHeight').val('');
    
                let object = activeTarget = canvas.getActiveObject();
                textTarget = null;
                
                if (object) {
                    $('#objectWidth').val((object.width*object.scaleX).toFixed());
                    $('#objectHeight').val((object.height*object.scaleY).toFixed());
    
                    function text(object){
                        if (object ?.type === 'textbox' ||
                            object ?.type === 'i-text' ||
                            object ?.type === 'text') {
                                if (!object.__eventListeners.changed) {
                                    object.on(
                                        'changed',
                                        function () {
                                            $('#textContent').val(object.text);
                                        },
                                    );
                                }
                                textTarget = object;
                                updateTextOptions(object);
                        }
                    }
    
                    if (object.type === 'group') {
                        findInnerElems(object, text);
                    }else{
                        text(object);
                    }
                }
            });
    
            $('#textContent').on('input',function(e){
                if (!canvas.getActiveObject()) {
                    return;
                }

                if (activeTarget === canvas.getActiveObject() && activeTarget.type !== 'activeSelection') {
                    if (activeTarget.type === 'group') {
                        activeTarget.addWithUpdate();
                    }
                    textTarget.text = e.target.value;
                    canvas.renderAll();
                }
            });
    
            function separateGroup(){
                try {
                if (
                    !canvas.getActiveObject() || 
                    canvas.getActiveObject().type !== 'group' ||
                    canvas.getActiveObject().bind
                    ) 
                    {
                        return;
                    }
    
                if (selectedGroup?.length) {
                    let flag = false;
    
                    selectedGroup.forEach(el => {
                        if (canvas.getActiveObject() === el) {
                            flag = true;
                        }
                    });
    
                    if (!flag) {
                        let obj = canvas.getActiveObject();
                        groupUpElements();
                        canvas.setActiveObject(obj);
                    } else {
                        is_edit_group = false;
                    }
                }
    
                if (!is_edit_group) {
                    is_edit_group = true;
                    let obj = canvas.getActiveObject();
                    selectedGroup = [];
                    
                    obj.forEachObject(function (object) {
                        selectedGroup.push(object);
                    });
    
                    masForGroupUp.push(selectedGroup);
    
                    obj.toActiveSelection();
                    canvas.discardActiveObject();
                    canvas.requestRenderAll();
                }
            } catch (error) {
                console.warn('Ошибка при разделении группы');
                console.warn('error: ', error);
                is_edit_group = false;
            }
            }
    
            function groupUpElements(options) {
                try {
    
                if (masForGroupUp?.length > 0) {
                    is_edit_group = false;
                    let sel;
    
                    for (let i = masForGroupUp.length - 1; i >= 0; i--) {
                        let group = masForGroupUp[i];
    
                        group.forEach((el, ind) => {
                            if (el?.type === 'group' && el?._objects?.length === 0) {
                                let obj = canvas.getActiveObject();
                                group[ind] = obj;
                            }
                        });
    
                        if (group?.length > 1) {
                            sel = new fabric.ActiveSelection(group, {
                                canvas: canvas,
                            });
    
                            canvas.setActiveObject(sel).getActiveObject().toGroup();
                            canvas.requestRenderAll();
                        } else if (group?.length === 1) {
                            canvas.setActiveObject(group[0]);
                        }
                    }
                    masForGroupUp = [];
                }
                } catch (error) {
                    console.warn('Ошибка соединения группы');
                    console.warn('error: ', error);
                }
            };
    
            function Remove() {
                let activeObjects = canvas.getActiveObjects();
    
                if (activeObjects?.length) {
                    activeObjects.forEach(function (object) {
                        masForGroupUp.forEach((group, indMas) => {
                            group.forEach((innerEl, ind) => {
                                if (innerEl === object) {
                                    let newGroup;
                                    group[ind] = null;
    
                                    newGroup = group.filter(el => el !== null);
    
                                    masForGroupUp[indMas] = newGroup;
                                }
                            });
                        });
    
                        canvas.remove(object);
                    });
    
                    canvas.discardActiveObject();
                    updateModifications();
                }
            }
    
            $('#our-demo #objectWidth,#our-demo #objectHeight').on('input',function(){
                let obj = canvas.getActiveObject();
                if ($(this).val()<0) {
                    $(this).val(0);
                }
    
                if (obj) {
// ------------ нажата ли пропорция --------------
                    if ($('#our-demo #proportion').is(':checked')) {
                        switch ($(this).attr('id')) {
                            case 'objectWidth':
                                obj.scaleToWidth($(this).val());
                                $('#our-demo #objectHeight').val((obj.height*obj.scaleY).toFixed());
                                break;
                            case 'objectHeight':
                                obj.scaleToHeight($(this).val());
                                $('#our-demo #objectWidth').val((obj.width*obj.scaleX).toFixed());
                                break;
                            default:
                                break;
                        }
                    }else{
                        switch ($(this).attr('id')) {
                            case 'objectWidth':
                                obj.set({
                                    scaleX: $(this).val()/obj.width,
                                });
                                break;
                                case 'objectHeight':
                                obj.set({
                                    scaleY: $(this).val()/obj.height,
                                });
                                break;
                            default:
                                break;
                        }
                    }
                    obj.setCoords();
                    canvas.renderAll();
                }
            });

            var observerForm1 = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutationRecord) {
                        if (mutationRecord.target.style.display === 'none') {
                            $('#rec387249820').hide();
                            return;
                        }
                        $('#rec387249789').hide();
                        $('#rec388162706').hide();
                        $('#rec387249820').show();
                    }); 
            });
    
            var triggerForm1 = document.querySelector('#rec387249789 #form387249789 .js-successbox');
            if (triggerForm1) {
                observerForm1.observe(triggerForm1, { attributes : true, attributeFilter : ['style'] });
            }
    
            function returnToWbForm(){
                $('#rec387249820').show();
                $('#rec387249894').hide();
            }
    
            $(document).ready(function(){
                document.querySelector('#form387249820 button').addEventListener('click',function(e){
                    let value = $('#form387249820 > div.t-container > div.t-col.t-col_8.t-prefix_2 > div.t186__wrapper > div.t186__blockinput > input').val();
                    loadWBPhoto(value);
                });
    
                $('#form387249820 div.t186__form-bottom-text > a').on('click',function(e){
                    $('#our-demo #mainPhotoUpload').click();
                });
    
                $('#form387249820 > div.t-container > div.t-col.t-col_8.t-prefix_2 > div.t186__wrapper').after($('.page-2 .mistake'));
    
                $('#form387249820 .mistake').hide();
    
                $('#form387249820 > div.t-container > div > div.t186__wrapper').before($('#form387249820 > div.t-container > div > div.t186__form-bottom-text.t-text.t-text_xs'))
    
                $('#form387249820  .js-successbox.t186__blockinput-success').remove();
                
                $('#form387249820 > div.t-container > div > div.t186__form-bottom-text.t-text.t-text_xs').css({
                    "font-size": "1.5em",
                    "font-weight": "400",
                    "margin-bottom": "1rem",
                });
    
                $('#rec387249894').css({
                    "margin-bottom": "2rem",
                });
    
                $('#form387249820 > div:nth-child(3) > input[type=text], #form387249789 > div:nth-child(3) > input[type=text]').each(function(){
                        if (uid) {
                            $(this).val('inf-'+ uid);
                        }
                });
    
                $('#form387249820 > div:nth-child(3) > input[type=text], #form387249789 > div:nth-child(3) > input[type=text]').on('change',function(){
                    if (uid) {
                        $(this).val('inf-'+ uid);
                    }
                });
            });
    
            function scrollToCanvas(){
                setTimeout(() => {
                    $('#our-demo')[0].scrollIntoView({behavior: "smooth"});
                }, 200);
            }
    
            function setObjCoords(x,y){
                $('#coordX').val(x.toFixed());
                $('#coordY').val(y.toFixed());
            }
    
            $("body").bind('copy', function() {
                Copy();
            });
            $("body").bind('paste', function() {
                Paste();
            });
    
            let _clipboard = null;
    
            function Copy() {
                canvas.getActiveObject().clone(function(cloned) {
                    _clipboard = cloned;
                },additionalProperties);
            }
    
            function Paste() {
                // clone again, so you can do multiple copies.
                _clipboard.clone(function(clonedObj) {
                    canvas.discardActiveObject();
                    
                    clonedObj.set({
                        left: clonedObj.left + 10,
                        top: clonedObj.top + 10,
                        evented: true,
                    });
    
                    if (clonedObj.type === 'activeSelection') {
                        // active selection needs a reference to the canvas.
                        clonedObj.canvas = canvas;
                        clonedObj.forEachObject(function(obj) {
                            canvas.add(obj);
                        });
                        // this should solve the unselectability
                        clonedObj.setCoords();
                    } else {
                        canvas.add(clonedObj);
                    }
                    _clipboard.top += 10;
                    _clipboard.left += 10;
                    canvas.setActiveObject(clonedObj);
                    canvas.requestRenderAll();
                    updateModifications();
                },additionalProperties);
            }
    
            document.onkeydown = function (event) {
                const x = ()=>{
                    canvas.clear().renderAll();
                    canvas.loadFromJSON(state[state.length - 1 - mods]);
                    canvas.renderAll();
                }

                if (event.ctrlKey && event.keyCode == 90) {
                    if (mods < state.length-1) {
                        mods++;
                        x();
                    }
                } else if (event.ctrlKey && event.keyCode == 89) {
                    if (mods > 0) {
                        mods--;
                        x();
                    }
                }else  if (event.key === "Delete") {
                    if (canvas.getActiveObject() && !canvas.getActiveObject().isEditing) {
                        Remove();
                    }
                }
            };

    //------------mainPhoto-------------------------
        // $('#mainPhotoUpload').change(function (event) {
        //     try {
        //     let reader = new FileReader();
        //     reader.readAsDataURL(event.target.files[0]);
        //     reader.onload = function () {
        //         fabric.Image.fromURL(reader.result,
        //             function (img) {
        //                 img.set({
        //                     top: canvas.height / 2 - img.height * img.scaleY / 2,
        //                     left: canvas.width / 2 - img.width * img.scaleX / 2,
        //                     ownType: 'mainFoto',
        //                 });
        //                 canvas.setBackgroundImage(img);
        //                 canvas.renderAll();
        //                 mainFoto = fabric.util.object.clone(img);
    
        //                 $('#rec387249820').hide();
        //                 $('#rec387249894').show();
        //                 $('.container-page-move').removeClass('d-none');
        //                 $('#our-demo #mainPhotoUpload').val('');
        //                 scrollToCanvas();
        //             }
        //         );
        //     };
        //     } catch (error) {
        //         alert('Проблема при загрузке изображения!');
        //         console.error('error: ', error);
        //         $('#our-demo #mainPhotoUpload').val('');
        //     }
        // });
    
    // --------------------- CROPPER ------------------------
    let cropper;
    
    $('#our-demo #fileUpload, #our-demo #mainPhotoUpload').change(function (event) {
        try {
        let target =  $(this).attr('id');
        console.log('target: ', target);
        let reader = new FileReader();
        reader.readAsDataURL(event.target.files[0]);
        reader.onload = function () {
    
            let cropImg = document.getElementById('imageCrop');
            cropImg.setAttribute('src', reader.result);
    
            $('#our-demo #imageCropModal').show();
    
            function start(){
                let button = document.getElementById('applyCrop');
    
                    button.onclick = function () {
                        let croppedCanvas = cropper.getCroppedCanvas();
    
    // --------------------- замена изображения ------------------
                        if (targetImage) {
                            let width = targetImage.width;
                            let scaleX = targetImage.scaleX;
                            let height = targetImage.height;
                            let scaleY = targetImage.scaleY;

                            targetImage.setSrc(croppedCanvas.toDataURL(), function (image) {
                                image.set({
                                    dirty: true,
                                });
                                if (image.clipPath) {
                                    image.clipPath.scaleToWidth(image.width);
                                }
                                image.setCoords(true);
                                image.scaleToWidth(width*scaleX);
                                targetImage = image;
                                canvas.renderAll();
                                updateModifications();
                            });
    // --------------------- добавление нового изображения ------------------
                        }else{
                            fabric.Image.fromURL(croppedCanvas.toDataURL(), function (img) {
                                if (img.width > img.height) {
                                    img.scaleToWidth(canvas.width/2);
                                }else{
                                    img.scaleToHeight(canvas.height/2);
                                }
        
                                img.set({
                                    top:  canvas.height/2 - img.height*img.scaleY/2,
                                    left: canvas.width/2 - img.width*img.scaleX/2,
                                    hasControls: true,
                                });
        
                                canvas.add(img);
                                canvas.renderAll();
                                canvas.setActiveObject(img);
                                updateModifications();
                            });
                        }
                    };
            }

            let ratio = 3/4;
    // --------------------- замена изображения ------------------
            if (targetImage) {
                ratio = targetImage.width*targetImage.scaleX / (targetImage.height*targetImage.scaleY);

                cropper = new Cropper(cropImg, {
                    aspectRatio: ratio,
                    // zoomOnWheel: false, // запрет scrolla
                    viewMode: 2,
                    
                    ready: function () {
                        start();
                    },
                    // cropmove: function () {
                    //     console.log('move');
                    // },
                });
    // -------------- добавление нового изображения ------------
            }else{
                cropper = new Cropper(cropImg, {
                    initialAspectRatio:ratio,
                    viewMode: 2,
                    
                    ready: function () {
                        start();
                    },
                });
            }
        };
        } catch (error) {
                alert('Проблема при загрузке изображения!');
                console.error('error: ', error);
                $('#our-demo #fileUpload, #our-demo #mainPhotoUpload').val('');
        }
    });
    
    // --------------------- CROPPER destroy------------------------
    $('#imageCropModal').on('click', 'button[data-dismiss="modal"]', function(){
        cropper.destroy();
        $('#fileUpload').val('');
        $('#our-demo #imageCropModal').hide();
    });
    
    // --------- изменение изображения (круглое / нет) --------------
    $('#imageBorderCircle').on('change', function () {
        let target = canvas.getActiveObject();
    
        const isImage = function (obj) {
            if (obj && obj.type === 'image') {
                return true;
            } else {
                return false;
            }
        };
    
        if (isImage(target)) {
            if ($('#imageBorderCircle').prop('checked')) {
                createCircleImage(target);
            }else{
                target.clipPath = null;
                canvas.renderAll();
            }
        }
    });
    
    // ------------ создание круглого изображения --------------
    function createCircleImage(target) {
        let side;
    
        if (target.width  <= target.height) {
            side = target.width;
        } else {
            side = target.height;
        }
    
        target.clipPath = new fabric.Circle({
            radius: side / 2,
            originX: 'center',
            originY: 'center',
        });
    
        canvas.renderAll();
    }

// ------------ контроллер кнопок --------------
    function controlsForObject(_this, value){
            let attr = _this.attr('name');
            let target=null;
            switch (attr) {
                case 'plus-w':
                    target = $('#our-demo #objectWidth');
                    value=+target.val() + value;
                    break;
                case 'plus-h':
                    target = $('#our-demo #objectHeight');
                    value=+target.val() + value;
                    break;
                case 'minus-w':
                    target = $('#our-demo #objectWidth');
                    value=+target.val() - value;
                    break;
                case 'minus-h':
                    target = $('#our-demo #objectHeight');
                    value=+target.val() - value;
                    break;
                case 'minus-fz':
                    target = $('#our-demo #textFontSize');
                    value=+target.val() - value;
                    break;
                case 'plus-fz':
                    target = $('#our-demo #textFontSize');
                    value=+target.val() + value;
                    break;
                default:
                    break;
            }

            if (!target) {
                return;
            }

            target.val(value);
            target.trigger('input');
        }

// ------------ возможность зажима кнопок --------------
        let timeoutId = null;
        let intervalId = null;

        $('#our-demo .btns-number').on('mousedown','button', function(){
            let _this = $(this);
            controlsForObject(_this, 1);

            timeoutId = setTimeout( function () {
                intervalId = setInterval(function(){
                    controlsForObject(_this, 5);
                },50);
            }, 500);
        });

        $("#our-demo .btns-number button").mouseup(function() {
            clearInterval(intervalId);
            clearTimeout(timeoutId);
        }).mouseleave(function() {
            clearInterval(intervalId);
            clearTimeout(timeoutId);
        });

// ------------ тригер пропорции --------------
        $('#our-demo #proportion').change(function(){
            $('#our-demo #objectWidth').trigger('input');
        });
// ------------- updateModifications -----------------------
        canvas.on('object:modified',function(){
            updateModifications();
        });

        let mods = 0,
            state = [],
            additionalProperties = [
                'hasControls',
            ];
            
        function stringifyCanvas(canvas){
                try {
                    sCanvas = JSON.stringify(canvas);
                    oCanvas = JSON.parse(sCanvas);

                    $.each(oCanvas.objects, function(n, object) {
                        $.each(additionalProperties, function(m, field) {
                            oCanvas.objects[n][field] = canvas.item(n)[field];
                        });
                    });
                
                    return JSON.stringify(oCanvas);
                } catch (error) {
                    console.error('Ошибка при конвертировании canvas');
                    throw "Stop updateModifications";
                }
        }

        function updateModifications() {
                var cnt = canvas.getObjects().length;
                if(cnt === 0){
                    //Холст пустой, сохранять нет смысла...
                    return;
                }
                
                // const json = stringifyCanvas(canvas);
                const json = canvas.toJSON(additionalProperties);

                if (mods === 0) {
                    state.push(json);
                    return;
                }

                
                if (mods !== 0) {
                    state.push(state[state.length - 1 - mods]);
                    mods = 0;
                    state.push(json);
                }
        }

        $('#textFontFamily, #textFontSize, #textColor, #textBold, #textItalic, #textUnderline, #textLineThrough').on('change',function(){
            const obj = canvas.getActiveObject();
            if (!obj) {
                return;
            }
            updateModifications();
        });

        let saveTimer1 = {
            x: function (){
                saveTimer1.time = setTimeout(() => {
                    updateModifications();
                    saveTimer1.time = null;
                }, 1500);
            },
            time: null,
            y: function(){
                if (saveTimer1.time) {
                    clearTimeout(saveTimer1.time);
                    saveTimer1.x();
                }else{
                    saveTimer1.x();
                }
            },
            z: function(){
                saveTimer1.y();
                $(this).off('mouseleave', saveTimer1.z);
            },
        };

        $('#our-demo .btns-number').on('mousedown','button', function(){
            $(this).off('mouseleave', saveTimer1.z);
            $(this).mouseleave(saveTimer1.z);
        });

        $("#our-demo .btns-number button").mouseup(function() {
            saveTimer1.y();
        });

    </script>
    