<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <style>
        :root {
            --width: min(calc(80vw - 2rem), 900px);
        }

        .d-none {
            display: none !important;
        }

        .mistake {
            display: none;
            text-align: center;
            font-size: 1.5em;
            color: hsl(0 60% 50%)
        }

        .mistake.show {
            display: block;
        }

        .shadow {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            opacity: 1;
            background-color: rgb(65, 55, 55);
        }

        .container-page-move {
            /* position: absolute;
            top: 0;
            left: 0; */
            display: flex;
            align-items: flex-start;
        }

        .container-page-move button:nth-child(1) {
            border-radius: 0;
            background-color: hsl(0 0% 50%);
            font-size: 1.2rem;
        }

        .container-page-move button:nth-child(2) {
            border-radius: 0 0 10px 0;
            background-color: hsl(0 0% 50%);
            font-size: 1.2rem;
        }

        .canvas-scale {
            margin-left: 1rem;
            display: flex;
            font-size: 1.5rem;
        }

        .canvas-scale select {
            margin-left: .6rem;
            width: 8ch;
        }

        .page,
        .inner-page {
            display: none;
        }

        .page.active,
        .inner-page.active {
            display: block;
        }

        body {
            font-size: 1vw;
            overflow: auto;
        }

        h1 {
            text-align: center;
            font-size: max(20px, 3em);
        }

        label,
        p {
            margin: 0;
            font-size: max(2em, 14px);
        }

        input:focus {
            border: 2px solid green;
            border-radius: 5px;
            outline: none;
        }

        .continer {
            margin: 1rem;
            /* overflow: hidden; */
        }

        .page-1,
        .page-2 {
            top: 50%;
            left: 50%;
            transform: translateX(-50%) translateY(-50%);
            position: absolute;
            width: min(75%, 500px);
        }

        .form-1,
        .page-2>div {
            display: grid;
            gap: .5rem
        }

        .form-1 input,
        .page-2 input {
            font-size: 2em;
        }

        .page-2 button {
            font-size: 2em;
        }

        #zoomRange {
            margin-left: .5rem;
            font-size: max(2em, 14px);
            width: 4ch;
        }

        #cropModal .modal-body> :nth-child(2) {
            display: flex;
            flex-direction: column;
        }

        #cropModal .modal-body> :nth-child(2) label {
            align-self: baseline;
        }

        .--canvas {
            margin: 0 0 4rem 0;
        }

        .canvas {
            overflow: hidden;
        }

        .canvas-container {
            margin: 0 auto;
        }

        #c,
        .upper-canvas,
        .canvas-container {
            border: 1px solid #000;
            max-width: var(--width);
            max-height: calc(var(--width)*4/3);
            min-width: var(--width);
            min-height: calc(var(--width)*4/3);
        }

        .templates {
            display: flex;
            overflow-x: auto;
            gap: 0.5rem;
            align-items: flex-start;
            min-height: 80px;
        }

        .templates img {
            width: 50px;
            cursor: pointer;
        }

        .wb-projects {
            display: none;
        }

        .wb-projects img {
            cursor: pointer;
        }

        .save-canvas {
            position: absolute;
            top: 0;
            right: 0;
        }

        .save-canvas button {
            border-radius: 0 0 0 10px;
            background-color: hsl(0 0% 50%);
            font-size: 1.2rem;
            padding: 0.2rem 0.4rem 0.2rem 0.4rem;
        }

        @media screen and (min-width: 376px) {
            .templates img {
                width: 80px;
            }
        }

        @media screen and (min-width: 565px) {
            .templates img {
                width: 100px;
            }
        }

        @media screen and (min-width: 720px) {
            .templates img {
                width: 120px;
            }
        }

        @media screen and (min-width: 1400px) {
            .wb-projects {
                display: flex;
                gap: 0.5rem;
                flex-direction: column;
                margin-right: 1rem;
                padding-right: 1rem;
                border-right: 1px solid #000;
            }

            .wb-projects img {
                width: 100px;
            }

            .page-1 {
                width: 33vw;
            }

            h1 {
                font-size: 3rem;
            }

            p,
            label,
            #zoomRange {
                font-size: 1.3em;
            }

            #zoomRange {
                width: 5ch;
            }

            #cropModal label input {
                transform: scale(1.4);
            }

            .form-1 {
                gap: 1rem;
            }

            .form-1 * {
                font-size: 2.1rem;
            }

            .desktop-content {
                display: flex;
                justify-content: left;
            }

            .--canvas {
                margin: 0;
                margin: 0 auto;
            }

            .templates {
                flex-wrap: wrap;
            }

            .redactor {
                margin-right: 1rem;
            }

            .redactor .tools button {
                width: 33px;
                height: 33px;
            }

            .redactor .tools button:hover {
                outline: 2px solid rgb(119, 239, 255);
            }

            .redactor .tools button:focus {
                outline: 2px solid rgb(119, 239, 255);
                box-shadow: none;
            }

            .redactor .tools button.active {
                background-color: #2592c1;
            }
        }
    </style>

    <!-- ________________________________ -->

    <header>
        <div class="container-page-move d-none">
            <button class="return btn">Назад</button>
            <button class="next-inner-page btn">Вперёд</button>
            <div class="canvas-scale">
                <div>Масштаб:</div>
                <select class="" onchange="setScale($(this).val())">
                    <option value="smart" selected>smart</option>
                    <option value="1">1</option>
                    <option value="0.75">0.75</option>
                    <option value="0.5">0.5</option>
                </select>
            </div>
        </div>
    </header>

    <div class="continer">

        <section class="page page-1 active">
            <h1>Введите ваш номер телефона</h1>
            <label for="form-1-phone">Номер телефона</label>
            <form class="form form-1">
                <input id="form-1-phone" type="tel" name="phone" class="form-control">
                <input class="next-page btn" type="submit">
            </form>
        </section>

        <section class="page page-2">
            <h1>Введите артикул товара на Wildberries</h1>
            <label for="articul">Артикул</label>
            <div class="">
                <input type="text" id="articul" />
                <button class="btn" onclick="loadWBPhoto($('#articul').val())">Загрузить</button>
                <div class="mistake">
                    <div>Фото не найдено!<br>Впишите в поле реальный артикул</div>
                </div>
            </div>
        </section>

        <section class="page page-3">
            <h1 id="title-1" class="title">Выберете шаблон</h1>

            <div class="desktop-content">
                <!-- <section class="wb-projects">
                    <img src="https://lk.infograffer.ru/templates/63/cover.jpg">
                    <img src="https://lk.infograffer.ru/templates/62/cover.jpg">
                    <img src="https://lk.infograffer.ru/templates/61/cover.jpg">
                </section> -->

                <section class="inner-page inner-page-2 redactor">
                    <div class="tools">
                        <p>Инструменты:</p>
                        <div class="">
                            <button id="select" title="Выделение" class="btn tool-btns__item btn-sm active"
                                type="button" onclick="">
                                <i class="bi bi-cursor-fill"></i>
                            </button>
                            <button id="move" title="Перемещение" class="btn tool-btns__item btn-sm" type="button"
                                onclick="">
                                <i class="bi bi-arrows-move"></i>
                            </button>
                            <button id="text" title="Текст" class="btn tool-btns__item btn-sm" type="button" onclick="">
                                <i class="bi bi-cursor-text"></i>
                            </button>
                            <button id="image" title="Изображение" class="btn tool-btns__item btn-sm" type="button"
                                onclick="">
                                <i class="bi bi-card-image"></i>
                            </button>
                        </div>
                    </div>
                    <div class="tool text" id="toolText">
                        <div>
                            <label class="form-label">Шрифт</label>
                            <select class="form-select text-font-family" id="textFontFamily" oninput="">
                                <option value="PT Sans" style="font-family:'PT Sans'">PT Sans</option>
                                <option value="Nunito" style="font-family:'Nunito'">Nunito</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Размер шрифта</label>
                            <input type="number" id="textFontSize" min="8" max="100" value="40" step="1" oninput=""
                                class="form-select">
                        </div>
                        <div>
                            <label class="form-label">Цвет шрифта</label>
                            <input type="color" id="textColor" oninput="">
                        </div>
                        <div>
                            <label class="form-label">Цвет фона</label>
                            <input type="color" id="textbackgroundColor" oninput=""><br>
                            <button type="button" class="btn btn-info btn-sm" onclick=""> Установить прозрачный цвет
                                фона</button>
                        </div>
                        <div class="text__options">
                            <p>Стиль:</p>
                            <div class="">
                                <label class="form-label">
                                    <input type="checkbox" id="textBold" name="text[font_style]" onchange="">Жирный
                                </label>
                                <label class="form-label">
                                    <input type="checkbox" id="textItalic" name="text[font_style]" onchange="">Курсив
                                </label>
                                <label class="form-label"><input type="checkbox" id="textUnderline"
                                        name="text[font_style]" onchange="">Подчёркнутый
                                </label>
                                <label class="form-label">
                                    <input type="checkbox" id="textLineThrough" name="text[font_style]"
                                        onchange="">Зачёркнутый
                                </label>
                            </div>
                        </div>
                        <div>
                            <p class="form-label">Выравнивание:</p>
                            <select class="form-select text-text-align" id="textAlign" onchange="">
                                <option value="left">по левому краю</option>
                                <option value="center">по центру</option>
                                <option value="right">по правому краю</option>
                            </select>
                        </div>
                        <div>
                            <button type="button" onclick="" class="btn btn-primary">Добавить</button>
                        </div>
                    </div>
                </section>

                <section class="inner-page inner-page-1 active">
                    <div class="templates">
                        <img src="https://lk.infograffer.ru/templates/64/cover.jpg">
                        <img src="https://lk.infograffer.ru/templates/64/cover.jpg">
                        <img src="https://lk.infograffer.ru/templates/64/cover.jpg">
                        <img src="https://lk.infograffer.ru/templates/64/cover.jpg">
                        <img src="https://lk.infograffer.ru/templates/64/cover.jpg">
                        <img src="https://lk.infograffer.ru/templates/64/cover.jpg">
                        <img src="https://lk.infograffer.ru/templates/64/cover.jpg">
                        <img src="https://lk.infograffer.ru/templates/64/cover.jpg">
                        <img src="https://lk.infograffer.ru/templates/64/cover.jpg">
                        <img src="https://lk.infograffer.ru/templates/64/cover.jpg">
                    </div>
                </section>

                <section class="--canvas">
                    <div class="canvas">
                        <canvas id="c" width="450" height="600"></canvas>
                    </div>
                </section>

            </div>
        </section>
    </div>

    <div class="save-canvas d-none">
        <button onclick="downloadImage('jpeg')">Сохранить как jpeg</button>
    </div>

    <!-- ________________________________ -->
    <script src="https://unpkg.com/fabric@4.6.0/dist/fabric.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/webfont/1.6.28/webfontloader.js"
        integrity="sha512-v/wOVTkoU7mXEJC3hXnw9AA6v32qzpknvuUF6J2Lbkasxaxn2nYcl+HGB7fr/kChGfCqubVr1n2sq1UFu3Gh1w=="
        crossorigin="anonymous" referrerpolicy="no-referrer">

    </script>

    <script src='/canvas.js'></script> -->

    <script>
        let cropImg = document.getElementById('cropImage');
        let page = 1;
        let mainFoto = null;
        let innerPage = mainFoto == null ? 1 : 2;
        let x = true;

        // function loadCss(url, integrity, referrerpolicy = '') {
        //     return new Promise(resolve => {
        //         var link = document.createElement("link");
        //         link.type = "text/css";
        //         link.rel = "stylesheet";
        //         link.href = url;
        //         link.crossOrigin = "anonymous";
        //         link.integrity = integrity;
        //         link.referrerpolicy = referrerpolicy;
        //         document.getElementsByTagName("head")[0].appendChild(link);
        //         resolve(!x);
        //     });
        // }

        $(document).ready(function () {
            openPage('.page', page);
            openPage('.inner-page', innerPage);
        });

        function openPage(selector, number) {
            console.log('selector: ', selector);
            console.log('number: ', number);

            function closeAll() {
                document.querySelectorAll(`${selector}.active`).forEach(item => {
                    item.classList.remove('active');
                });
            }
            closeAll();

            document.querySelector(`${selector}-${number}`).classList.add('active');


            if (selector === '.inner-page') {
                switch (number) {
                    case 1:
                        $('#title-1').text('Выберете шаблон');
                        $('.return').attr('disabled', true);
                        $('.container-page-move .next-inner-page').attr('disabled', false);
                        $('.save-canvas').addClass('d-none');
                        break;
                    case 2:
                        $('#title-1').text('Измените шаблон');
                        $('.return').attr('disabled', false);
                        $('.container-page-move .next-inner-page').attr('disabled', true);
                        $('.save-canvas').removeClass('d-none');
                        break;

                    default:
                        break;
                }
            }
        }

        //Обработка форм
        document.querySelectorAll("form").forEach(item => {
            item.addEventListener('submit', function (event) {
                let form = this;
                event.preventDefault();

                let formData = new FormData(form);

                console.log(JSON.stringify(Object.fromEntries(formData)));

                // for (const [key, value] of formData) {
                //     console.log(key +' \ '+value);
                // }
            });
        });

        //переключение страниц
        document.querySelectorAll('.next-page').forEach(item => {
            item.addEventListener('click', function (event) {
                openPage('.page', page += 1);
            });
        });

        document.querySelectorAll('.next-inner-page').forEach(item => {
            item.addEventListener('click', function (event) {
                openPage('.inner-page', innerPage += 1);
            });
        });

        document.querySelectorAll('.return').forEach(item => {
            item.addEventListener('click', function (event) {
                openPage('.inner-page', innerPage -= 1);
            });
        });

        $('#mainPhotoUpload').change(function (event) {
            cropImageStart();
        });

        $('.redactor .tools button').on('click', function () {
            const el = $('.redactor .tools button.active')[0];

            if (el != $(this)[0]) {
                el.classList.remove('active');
                $(this).addClass('active');
            }
        });

        function loadWBPhoto(acticul) {
            const articulPart = acticul.substr(0, 4);
            const url = 'https://images.wbstatic.net/big/new/' + articulPart + '0000/' + acticul + '-1.jpg';
            $.ajax({
                url: url,
                success: function (resp) {
                    $('.mistake').removeClass('show');
                    openPage('.page', page += 1);
                    fabric.Image.fromURL(url, function (img) {
                        img.scaleToHeight(600);
                        img.set({
                            left: 0,
                            top: 0,
                            ownType: 'mainFoto',
                        });
                        canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
                    },{
                        crossOrigin: 'anonymous',
                    });

                    $('.container-page-move').removeClass('d-none');
                },
                error: function () {
                    $('.mistake').addClass('show');
                }
            })
        }

        $('.templates img').on('click', function () {
            openPage('.inner-page', innerPage += 1);
        });

        function downloadImage(ext) {
            if (ext === 'jpeg') {
                canvas.backgroundColor = '#ffffff';
                canvas.requestRenderAll();
            }

            const base64 = canvas.toDataURL({
                format: ext,
                enableRetinaScaling: true
            });

            let currentDate = new Date();
            let time = (currentDate.getMonth() + 1) + '-' + currentDate.getDate() + '-' + currentDate.getHours() +
                '-' + currentDate.getMinutes() + '-' + currentDate.getSeconds();

            // $.ajax('/project/export/?type=image&id_project=' + id_project + '&id_image=' + id_image, {
            //     type: 'post',
            //     data: {
            //         data: base64,
            //         ext: ext
            //     }
            // });

            const link = document.createElement("a");
            link.href = base64;
            link.download = `infograffer-${time}.${ext}`;
            link.click();
        }
    </script>
</body>

</html>