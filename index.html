<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <style>
        @import"https://fonts.googleapis.com/css2?family=PT+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap";@import"https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200;0,300;0,400;0,600;0,700;0,800;0,900;1,200;1,300;1,400;1,600;1,700;1,800;1,900&display=swap";@import"https://fonts.googleapis.com/css2?family=Lobster&display=swap";@import"https://fonts.googleapis.com/css2?family=Pacifico&display=swap";
        @import 'https://fonts.googleapis.com/css2?family=Caveat:wght@400;500;600;700&display=swap';
           
           /*kv - new */
           @import "https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;1,100;1,300;1,400;1,500;1,700&display=swap";
    </style>
    <div class="continer" id="our-demo">
        <section class="page page-2 active">
            <h1 class="change-elem">Введите артикул товара на Wildberries</h1>
            <label class="hide-elem" for="articul">Артикул</label>
            <div class="hide-elem">
                <input type="text" id="articul" />
                <button class="btn" onclick="loadWBPhoto($('#articul').val())">Загрузить</button>
                <div class="mistake">
                    <div>Фото не найдено!<br>Впишите в поле реальный артикул</div>
                </div>
            </div>
            <p class="hide-elem">или</p>
            <div class="">
                <button class="btn" onclick="$('#mainPhotoUpload').click()">Выберете файл</button>
                <input type="file" id="mainPhotoUpload" class="d-none" accept="image/jpeg, image/png">
            </div>
        </section>

        <section class="page page-3">
            <div class="title-container">
                <h1 id="title-1" class="title">Выберете шаблон</h1>
            </div>

            <div class="desktop-content">
                <section class="--canvas">
                    <div class="canvas">
                        <canvas id="c" width="900" height="1200"></canvas>
                    </div>
                </section>

                <section class="inner-page inner-page-1 active">
                    <div class="container-page-move d-none">
                        <button class="btn return" onclick="returnToWbForm()">Загрузить фото</button>
                    </div> 

                    <div class="templates">
                        <img data-template-id='1' src="http://stage.infograffer.ru/templates/254/cover.jpg">
                        <img data-template-id='3' src="http://stage.infograffer.ru/templates/14/cover.jpg">
                        <img data-template-id='4' src="http://stage.infograffer.ru/templates/62/cover.jpg">
                        <img data-template-id='5' src="http://stage.infograffer.ru/templates/1005/cover.jpg">
                        <img data-template-id='6' src="http://stage.infograffer.ru/templates/3/cover.jpg">
                        <img data-template-id='7' src="http://stage.infograffer.ru/templates/247/cover.jpg">
                        <img data-template-id='8' src="http://stage.infograffer.ru/templates/258/cover.jpg">
                        <img data-template-id='9' src="http://stage.infograffer.ru/templates/63/cover.jpg">
                        <img data-template-id='10' src="http://stage.infograffer.ru/templates/60/cover.jpg">
                    </div>

                    <div class="">
                        <button class="btn" onclick="openPage('.inner-page', innerPage += 1);">Применить</button>
                    </div>
                </section>

                <section class="inner-page inner-page-2 redactor">
                    <div class="tool-btns">
                        <p class="title">Инструменты:</p>
                        <div class="">
                            <button title="Назад" class="btn tool-btns__item return" type="button">
                                <p>назад</p>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-return-left" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M14.5 1.5a.5.5 0 0 1 .5.5v4.8a2.5 2.5 0 0 1-2.5 2.5H2.707l3.347 3.346a.5.5 0 0 1-.708.708l-4.2-4.2a.5.5 0 0 1 0-.708l4-4a.5.5 0 1 1 .708.708L2.707 8.3H12.5A1.5 1.5 0 0 0 14 6.8V2a.5.5 0 0 1 .5-.5z"/>
                                </svg>
                            </button>
                            <button id="move" title="Положение" class="btn tool-btns__item" type="button" >
                                <p>положение</p>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                    class="bi bi-arrows-move" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd"
                                        d="M7.646.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 1.707V5.5a.5.5 0 0 1-1 0V1.707L6.354 2.854a.5.5 0 1 1-.708-.708l2-2zM8 10a.5.5 0 0 1 .5.5v3.793l1.146-1.147a.5.5 0 0 1 .708.708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 0 1 .708-.708L7.5 14.293V10.5A.5.5 0 0 1 8 10zM.146 8.354a.5.5 0 0 1 0-.708l2-2a.5.5 0 1 1 .708.708L1.707 7.5H5.5a.5.5 0 0 1 0 1H1.707l1.147 1.146a.5.5 0 0 1-.708.708l-2-2zM10 8a.5.5 0 0 1 .5-.5h3.793l-1.147-1.146a.5.5 0 0 1 .708-.708l2 2a.5.5 0 0 1 0 .708l-2 2a.5.5 0 0 1-.708-.708L14.293 8.5H10.5A.5.5 0 0 1 10 8z" />
                                </svg>
                            </button>
                            <button id="text" title="Текст" class="btn tool-btns__item btn-sm" type="button" >
                                <p>текст</p>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                    class="bi bi-cursor-text" viewBox="0 0 16 16">
                                    <path
                                        d="M5 2a.5.5 0 0 1 .5-.5c.862 0 1.573.287 2.06.566.174.099.321.198.44.286.119-.088.266-.187.44-.286A4.165 4.165 0 0 1 10.5 1.5a.5.5 0 0 1 0 1c-.638 0-1.177.213-1.564.434a3.49 3.49 0 0 0-.436.294V7.5H9a.5.5 0 0 1 0 1h-.5v4.272c.1.08.248.187.436.294.387.221.926.434 1.564.434a.5.5 0 0 1 0 1 4.165 4.165 0 0 1-2.06-.566A4.561 4.561 0 0 1 8 13.65a4.561 4.561 0 0 1-.44.285 4.165 4.165 0 0 1-2.06.566.5.5 0 0 1 0-1c.638 0 1.177-.213 1.564-.434.188-.107.335-.214.436-.294V8.5H7a.5.5 0 0 1 0-1h.5V3.228a3.49 3.49 0 0 0-.436-.294A3.166 3.166 0 0 0 5.5 2.5.5.5 0 0 1 5 2zm3.352 1.355zm-.704 9.29z" />
                                </svg>
                            </button>
                
                            <button id="icons" title="Иконки" class="btn tool-btns__item" type="button">
                                <p>иконки</p>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info"
                                    viewBox="0 0 16 16">
                                    <path
                                        d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z" />
                                </svg>
                            </button>

                            <button title="Сохранить" class="btn tool-btns__item save" type="button" onclick="downloadImage('png')">
                                <p>сохранить</p>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
                                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                    <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="tool text" id="toolText">
                        <div class="text-content">
                            <textarea id="textContent"></textarea>
                        </div>
                        <div>
                            <label class="form-label">Шрифт</label>
                            <select class="form-select text-font-family" id="textFontFamily"
                                oninput="changeText('fontFamily',$(this).val())">
                                <option value="PT Sans" style="font-family:'PT Sans'">PT Sans</option>
                                <option value="Nunito" style="font-family:'Nunito'">Nunito</option>
                                <option value="Lobster" style="font-family:'Lobster'">Lobster</option>
                                <option value="Pacifico" style="font-family:'Pacifico'">Pacifico</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Размер шрифта</label>
                            <input type="number" id="textFontSize" min="8" max="100" value="40" step="1"
                                oninput="changeText('fontSize',$(this).val())" class="form-select">
                            <div class="btns-number">
                                <button name="minus-fz" class="btn"></button>
                                <button name="plus-fz" class="btn"></button>
                            </div>
                        </div>
                        <div>
                            <label class="form-label">Цвет шрифта</label>
                            <input type="color" id="textColor" oninput="changeText('fill',$(this).val())">
                        </div>
                        <div class="text__options">
                            <p>Стиль:</p>
                            <div class="">
                                <label class="form-label">
                                    <input type="checkbox" id="textBold" name="text[font_style]"
                                        onchange="changeText('fontWeight',$(this).is(':checked') ? 'bold' : '')">Жирный
                                </label>
                                <label class="form-label">
                                    <input type="checkbox" id="textItalic" name="text[font_style]"
                                        onchange="changeText('fontStyle',$(this).is(':checked') ? 'italic' : '')">Курсив
                                </label>
                                <label class="form-label"><input type="checkbox" id="textUnderline"
                                        name="text[font_style]"
                                        onchange="changeText('underline',$(this).is(':checked') ? true : false)">Подчёркнутый
                                </label>
                                <label class="form-label">
                                    <input type="checkbox" id="textLineThrough" name="text[font_style]"
                                        onchange="changeText('linethrough',$(this).is(':checked') ? true : false)">Зачёркнутый
                                </label>
                            </div>
                        </div>

                        <div class="new-text-container">
                            <textarea id="newTextContent"></textarea>
                            <button type="button" onclick="addText()" class="btn btn-primary">Добавить текст</button>
                        </div>
                    </div>

                    <div class="tool icons">
                        <div class="accordion">
                            <div class="card">
                                <div class="card-header icon-category-header">
                                    1. Выбор категории иконок
                                </div>
                                <div class="card-content show">
                                    <div class="icon-category">
                                        <label>Выберите категорию иконок:</label>
                                        <select>
                                            <option value="" selected>Выберите категорию</option>
                                            <option value="7">Стрелки</option>
                                            <option value="39">Новый Год</option>
                                            <option value="40">Торговля</option>
                                            <option value="23">Мода</option>
                                            <option value="85">Флаги</option>
                                            <option value="12">Погода</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header iconPackList-header">
                                    2. Выберите пакет иконок
                                </div>
                                <div class="card-content">
                                    <div class="" id="iconPackList">
                                        <div class="list">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header iconList-header">
                                    3. Иконки
                                </div>
                                <div class="card-content">
                                    <div id="iconList">
                                        <div class="list">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tool move">
                            <p class="mt-2">Ширина</p>
                            <div class="">
                                <input id="objectWidth" type="number" min="0">
                                <div class="btns-number">
                                    <button name="minus-w" class="btn"></button>
                                    <button name="plus-w" class="btn"></button>
                                </div>
                            </div>
                            <p class="mt-2">Высота</p>
                            <div class="">
                                <input id="objectHeight" type="number" min="0">
                                <div class="btns-number">
                                    <button name="minus-h" class="btn"></button>
                                    <button name="plus-h" class="btn"></button>
                                </div>
                            </div>
                            <div class="coords">
                                <div class="">
                                    <p class="mt-2">Координаты X</p>
                                    <input id="coordX" type="number" value="0" disabled>
                                </div>
                                <div class="">
                                    <p class="mt-2">Координаты Y</p>
                                    <input id="coordY" type="number" value="0" disabled>
                                </div>
                            </div>
                    </div>
                </section>
            </div>
        </section>
    </div>

    <!-- ________________________________ -->
    <script src="https://unpkg.com/fabric@4.6.0/dist/fabric.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/webfont/1.6.28/webfontloader.js"
        integrity="sha512-v/wOVTkoU7mXEJC3hXnw9AA6v32qzpknvuUF6J2Lbkasxaxn2nYcl+HGB7fr/kChGfCqubVr1n2sq1UFu3Gh1w=="
        crossorigin="anonymous" referrerpolicy="no-referrer">

    </script>

    <script src='/canvas.js'></script>
    <script src='/script.js'></script>

    <script>
        let templates = null;

        $.ajax({
                url: 'https://stage.infograffer.ru/editor/export/templates/1/templates.json',
                success: function (data) {
                    templates = data;
                },
                error: function (jqXHR, exception) {
                    findProblem(jqXHR, exception)
                }
        })


    </script>

    <script>
        let cropImg = document.getElementById('cropImage');
        let page = 3;
        let mainFoto = null;
        let innerPage = mainFoto == null ? 1 : 2;
        let x = true;
        const fontsMas = [
            'PT Sans',
            'Nunito',
            'Lobster',
            'Pacifico',
        ];

        $(document).ready(function () {
            preLoadFonts();
            openPage('.page', page);
            openPage('.inner-page', innerPage);
        });

        function openPage(selector, number, flag=false) {
            function closeAll() {
                document.querySelectorAll(`${selector}.active`).forEach(item => {
                    item.classList.remove('active');
                });
            }
            closeAll();

            document.querySelector(`${selector}-${number}`).classList.add('active');

            if (selector === '.page') {
                if (number === 3) {
                    $('.container-page-move').removeClass('d-none');
                }else{
                    $('.container-page-move').addClass('d-none');
                }
            }

            if (flag) {
                $('.page-2 .hide-elem').hide();
                $('.page-2 .change-elem').text('Загрузите фотографию');
            }


            if (selector === '.inner-page') {
                switch (number) {
                    case 1:
                        $('#title-1').text('Выберете шаблон');
                        $('.container-page-move .next-inner-page').attr('disabled', false);
                        $('.save-canvas').addClass('d-none');
                        $('.tool-btns').css('display', 'none');
                        break;
                    case 2:
                        $('.tool-btns').css('display', 'flex');
                        $('#title-1').text('Измените шаблон');
                        $('.container-page-move .next-inner-page').attr('disabled', true);
                        $('.save-canvas').removeClass('d-none');
                        break;

                    default:
                        break;
                }
            }
        }

        //переключение страниц
        document.querySelectorAll('.next-page').forEach(item => {
            item.addEventListener('click', function (event) {
                openPage('.page', page += 1);
            });
        });

        document.querySelectorAll('.next-inner-page').forEach(item => {
            item.addEventListener('click', function (event) {
                openPage('.inner-page', innerPage += 1);
            });
        });

        $('.redactor .tools button').on('click', function () {
            const el = $('.redactor .tools button.active')[0];

            if (el != $(this)[0]) {
                el.classList.remove('active');
                $(this).addClass('active');
            }
        });

        function loadWBPhoto(acticul) {
            const articulPart = acticul.substr(0, acticul.length - 4);
            const url = 'https://images.wbstatic.net/big/new/' + articulPart + '0000/' + acticul + '-1.jpg';
            $.ajax({
                url: url,
                success: function (resp) {
                    $('#form387249820 .mistake').removeClass('show');
                    $('#our-demo').removeClass('d-none');
                    $('#rec387249820').hide();
                    $('.container-page-move').removeClass('d-none');
                    // openPage('.page', page += 1, true);

                    fabric.Image.fromURL(url, function (img) {
                        img.set({
                            top: canvas.height/2 - img.height*img.scaleY/2,
                            left: canvas.width/2 - img.width*img.scaleX/2,
                            ownType: 'mainFoto',
                        });
                        canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
                        mainFoto = fabric.util.object.clone(img);
                    }, {
                        crossOrigin: 'anonymous',
                    });
                },
                error: function (jqXHR, exception) {
                    $('#form387249820 .mistake').addClass('show');
                    findProblem(jqXHR, exception)
                }
            })
        }

        function findProblem(jqXHR, exception){
            let errMsg = '';
                        let text = 'Произошла ошибка!';

                        if (jqXHR.status === 0) {
                            text += `\nОшибка: Not connect. Verify Network`
                            errMsg+= 'error>> Not connect. Verify Network';
                        } else if (jqXHR.status == 404) {
                            text += `\nОшибка: Requested page not found (404)`;
                            errMsg+= 'error>> Requested page not found (404)';
                        } else if (jqXHR.status == 500) {
                            text += `\nОшибка: Internal Server Error (500)`;
                            errMsg+= 'error>> Internal Server Error (500)';
                        } else if (exception === 'parsererror') {
                            text += `\nОшибка: Requested JSON parse failed`;
                            errMsg+= 'error>> Requested JSON parse failed';
                        } else if (exception === 'timeout') {
                            text += `\nОшибка: Time out error`;
                            errMsg+= 'error>> Time out error';
                        } else if (exception === 'abort') {
                            text += `\nОшибка: Ajax request aborted`;
                            errMsg+= 'error>> Ajax request aborted';
                        } else {
                            text += `\nОшибка: Uncaught Error\n${jqXHR.responseText}`;
                            errMsg+= 'error>> Uncaught Error' + jqXHR.responseText;
                        }

                        text += `\nПожалуйста, перезагрузите страницу. Если ошибка повториться, напишите нам в чат`;
                        alert(text);
                        throw errMsg;
        }

        function downloadImage(ext) {
            try {
                if (ext === 'jpeg') {
                    canvas.backgroundColor = '#ffffff';
                    canvas.requestRenderAll();
                }

                $.ajax({
                    url: 'https://stage.infograffer.ru/editor/export/templates/1/sign.png',
                    xhrFields: {
                        responseType: 'blob'
                    },
                    success: function (data) {
                        let url = URL.createObjectURL(data);
                        fabric.Image.fromURL(url, function (img) {
                            img.set({
                                left: 0,
                                top: 0,
                            });
                            canvas.add(img);

                            try {
                                const base64 = canvas.toDataURL({
                                    format: 'jpeg',
                                    enableRetinaScaling: true,
                                    multiplier: 0.2,
                                });
                                
                                let time = getTime();

                                const link = document.createElement("a");
                                link.href = base64;
                                link.download = `infograffer-${time}.${ext}`;
                                link.click();
                            } catch (error) {
                                canvas.remove(img);
                                canvas.renderAll();
                            }



                            canvas.remove(img);
                            canvas.renderAll();

                        });
                    },
                    error: function (jqXHR, exception) {
                        findProblem(jqXHR, exception)
                    }
                });


            } catch (error) {
                console.error('error >>> ', error);
            }
        }

        function getTime(){
            let currentDate = new Date();
            return ((currentDate.getMonth() + 1) + '-' + currentDate.getDate() + '-' + currentDate.getHours() + '-' + currentDate.getMinutes() + '-' + currentDate.getSeconds());
        }

        function closeAll(selector, classValue) {
            document.querySelectorAll(selector).forEach(item => {
                item.classList.remove(classValue);
            });
        }

        function openOptions(value) {
            closeAll('.redactor .tool.active', 'active');
            $(`.redactor .tool.${value}`).addClass('active');
        }

        $('.tool-btns button').on('click', function () {
            if ($(this).hasClass('active') || $(this).hasClass('save') || $(this).hasClass('return')) {
                return;
            };

            closeAll('.tool-btns button.active', 'active');

            $(this).addClass('active');
            openOptions($(this).attr('id'));
        });

        $('.tool-btns button.return').on('click',function(){
            openPage('.inner-page', innerPage -= 1);
        });

        function addText() {
            if (selectedGroup?.length) {
                groupUpElements();
            }

            let text = new fabric.IText("Текст", {
                left: 100,
                top: 100,
                padding: 10,
                text: $('#newTextContent').val()?$('#newTextContent').val(): 'текст',
                textBackgroundColor: 'transparent',
                fontSize: $('#textFontSize').val(),
                fontFamily: $('#textFontFamily').val()?$('#textFontFamily').val(): 'PT Sans',
                fill: $('#textColor').val(),
                objectCaching: false,

                fontWeight: $('#textBold').is(':checked') ? 'bold' : '',
                linethrough: $('#textLineThrough').is(':checked') ? true : false,
                underline: $('#textUnderline').is(':checked') ? true : false,
                fontStyle: $('#textItalic').is(':checked') ? 'italic' : '',
            });

            canvas.add(text);
            canvas.setActiveObject(text);
            canvas.renderAll();
            activeTarget = text;
            textTarget = text;
            updateTextOptions(text);

            $('#textContent').show();
            $('#newTextContent').val('');
        }

        function removeInnerStyle(obj, attr) {
            if (!attr || !obj || !obj.styles[0] || !Object.keys(obj.styles[0]).length) {
                return;
            }

            const clear = function (_this, key) {
                if (!Object.keys(_this).length) {
                    delete obj.styles[0][key];
                }
            }

            $.each(obj.styles[0], function (key) {
                if ($(this)[0][attr] || $(this)[0][attr] === '') {
                    delete $(this)[0][attr];
                    clear($(this)[0], key);
                }
            });
        }

        function findInnerElems(obj, cb){
            if (obj?._objects && (obj?.type === 'group' || obj?.type === 'activeSelection')) {
                obj._objects.forEach(el => {
                    return findInnerElems(el, cb);
                });
            } else {
                cb(obj);
            }
        }

        function changeText(attribute, value) {
            const start = (object) => {
                if (object ?.type === 'textbox' ||
                    object ?.type === 'i-text' ||
                    object ?.type === 'text') {
                    if (object ?.setSelectionStyles && object ?.isEditing) {
                        let style = {};
                        style[attribute] = value;
                        object.setSelectionStyles(style);
                        object.setCoords();
                    } else {
                        removeInnerStyle(object, attribute);
                        object.set(attribute, value);
                    }
                    canvas.renderAll();
                }
            };

            let obj = canvas.getActiveObject();
            if (obj) {
                findInnerElems(obj, start);
                if (obj.type === 'group') {
                    obj.addWithUpdate();
                }
            }
        }

        //для предварительной прогрузки шрифтов
        function preLoadFonts() {
            fontsMas.forEach((font) => {
                canvas.add(new fabric.Textbox("тест", {
                    fill: '#000',
                    fontFamily: font,
                }));
                canvas.requestRenderAll();
            });

            canvas.forEachObject(function (object) {
                if (object.ownType !== 'mainFoto') {
                    canvas.remove(object);
                }
            });
            canvas.setBackgroundColor('');
            canvas.requestRenderAll();
            
            fabric.Object.prototype.hasControls = false;
        }

        $('.tool.icons .accordion .card-header').on('click', function(){
            let _this = $(this);
            $('.tool.icons .accordion .card-content').each(function(){
                if ($(this)[0] !== _this.next()[0]){
                    $(this).slideUp();
                }
            });

            $(this).next().slideToggle();
        });

        $('.icon-category select').on('change', function () {
            let id_category = $(this).val();
            if (id_category <= 0) {
                return;
            }

            $.ajax('https://stage.infograffer.ru/icon/packs/?id_category=' + id_category, {
                dataType: 'json',
                beforeSend: function () {

                },
                success: function (packs) {
                    $('#iconPackList .list').html(packs);
                    $('.accordion .iconPackList-header').click();
                    $('#iconPackList > div > p > i').append($('#iconPackList > div > select'));
                },
                error: function (jqXHR, exception) {
                    findProblem(jqXHR, exception)
                }
            });
        });

        $('#iconPackList').on('click', '[data-id_pack]', function () {
            let id_pack = $(this).data('id_pack');

            if (id_pack > 0) {
                $.ajax('https://stage.infograffer.ru/icon/icons/?id_pack=' + id_pack, {
                    dataType: 'json',
                    beforeSend: function () {

                    },
                    success: function (icons) {
                        $('#iconList .list').html(icons);
                        $('.accordion .iconList-header').click();
                        $('#iconList .list p, #iconList .list select').hide();
                    },
                    error: function (jqXHR, exception) {
                        findProblem(jqXHR, exception)
                    }
                });
            }
        });

        $('#iconPackList').on('click', 'a[href="#"]', function(e){
            e.preventDefault();
        });


        $('#iconPackList').on('change', '[name="packs_page"]', function () {
            let id_category = $(this).data('id_category');
            let page = $(this).val();
            console.log('page: ', page);

            $.ajax('https://stage.infograffer.ru/icon/packs/?id_category=' + id_category + '&page=' + page, {
                dataType: 'json',
                beforeSend: function () {

                },
                success: function (packs) {
                    $('#iconPackList .list').html(packs);
                    $('#iconPackList > div > p > i').append($('#iconPackList > div > select'));
                },
                error: function (jqXHR, exception) {
                    findProblem(jqXHR, exception)
                }
            })
        })

        $('#iconList').on('click', '.add-icon', function () {
            let url = $(this).attr('src');
            fabric.Image.fromURL(url, function (img) {
                img.set({
                    left: 10,
                    top: 10,
                    ownType: 'icon',
                });
                img.scale(0.3);
                canvas.add(img);
            }, {
            crossOrigin: 'anonymous',
            });
        });

        $('.templates').on('click', 'img', function () {
            let id_template = $(this).data('template-id');

            if (id_template>0) {
                templates[id_template].backgroundImage = mainFoto;
                templates[id_template].backgroundColor = '#fff';
                canvas.loadFromJSON(templates[id_template]);
                canvas.renderAll();
            }
        });


        let doubleClicked = {
            flag: false,
            target: null,
        };
        let selectedGroup = [];
        let masForGroupUp = [];
        let is_edit_group = false;
        let activeTarget = null;
        let textTarget = null;
        
        function updateTextOptions(obj){
                $('#textContent').val(obj.text);
                $('#textFontFamily').val(obj.fontFamily);
                $('#textFontSize').val(obj.fontSize);
                $('#textColor').val(obj.fill);
                $('#textBold').prop('checked',(obj.fontWeight > 500 || obj.fontWeight === 'bold')?true:false);
                $('#textItalic').prop('checked',obj.fontStyle==='italic'?true:false);
                $('#textUnderline').prop('checked',obj.underline?true:false);
                $('#textLineThrough').prop('checked',obj.linethrough?true:false);
        }

        canvas.on("mouse:up",function(e){
            $('#textContent').val('');
            $('#objectWidth').val('');
            $('#objectHeight').val('');

            // if (doubleClicked.flag) {
            //     if (doubleClicked.target === e.target) {
            //         separateGroup();
            //     }
            //     return;
            // }

            // doubleClicked.flag = true;
            // doubleClicked.target = e.target;
            // setTimeout(() => {
            //     doubleClicked.flag = false;
            //     doubleClicked.target = null;
            // }, 300);

            if (selectedGroup?.length) {
                let flag = false;

                selectedGroup.forEach(el => {
                    if (e.target === el && e.target) {
                        flag = true;
                    }
                });

                if (!flag) {
                    groupUpElements();
                }
            }

            let object = activeTarget = canvas.getActiveObject();
            textTarget = null;
            
            if (object) {
                setObjCoords(object.left, object.top);

                $('#objectWidth').val((object.width*object.scaleX).toFixed());
                $('#objectHeight').val((object.height*object.scaleY).toFixed());

                function text(object){
                    if (object ?.type === 'textbox' ||
                        object ?.type === 'i-text' ||
                        object ?.type === 'text') {
                            if (!object.__eventListeners.changed) {
                                object.on(
                                    'changed',
                                    function () {
                                        $('#textContent').val(object.text);
                                    },
                                );
                            }
                            textTarget = object;
                            updateTextOptions(object);
                    }
                }

                if (object.type === 'group') {
                    findInnerElems(object, text);
                }else{
                    text(object);
                }
            }
        });

        $('#textContent').on('input',function(e){
            if (activeTarget === canvas.getActiveObject() && activeTarget.type !== 'activeSelection') {
                if (activeTarget.type === 'group') {
                    activeTarget.addWithUpdate();
                }
                textTarget.text = e.target.value;
                canvas.renderAll();
            }
        });

        function separateGroup(){
            try {
            if (
                !canvas.getActiveObject() || 
                canvas.getActiveObject().type !== 'group' ||
                canvas.getActiveObject().bind
                ) 
                {
                    return;
                }

            if (selectedGroup?.length) {
                let flag = false;

                selectedGroup.forEach(el => {
                    if (canvas.getActiveObject() === el) {
                        flag = true;
                    }
                });

                if (!flag) {
                    let obj = canvas.getActiveObject();
                    groupUpElements();
                    canvas.setActiveObject(obj);
                } else {
                    is_edit_group = false;
                }
            }

            if (!is_edit_group) {
                is_edit_group = true;
                let obj = canvas.getActiveObject();
                selectedGroup = [];
                
                obj.forEachObject(function (object) {
                    selectedGroup.push(object);
                });

                masForGroupUp.push(selectedGroup);

                obj.toActiveSelection();
                canvas.discardActiveObject();
                canvas.requestRenderAll();
            }
        } catch (error) {
            console.warn('Ошибка при разделении группы');
            console.warn('error: ', error);
            is_edit_group = false;
        }
        }

        function groupUpElements(options) {
            try {

            if (masForGroupUp?.length > 0) {
                is_edit_group = false;
                let sel;

                for (let i = masForGroupUp.length - 1; i >= 0; i--) {
                    let group = masForGroupUp[i];

                    group.forEach((el, ind) => {
                        if (el?.type === 'group' && el?._objects?.length === 0) {
                            let obj = canvas.getActiveObject();
                            group[ind] = obj;
                        }
                    });

                    if (group?.length > 1) {
                        sel = new fabric.ActiveSelection(group, {
                            canvas: canvas,
                        });

                        canvas.setActiveObject(sel).getActiveObject().toGroup();
                        canvas.requestRenderAll();
                    } else if (group?.length === 1) {
                        canvas.setActiveObject(group[0]);
                    }
                }
                masForGroupUp = [];
            }
            } catch (error) {
                console.warn('Ошибка соединения группы');
                console.warn('error: ', error);
            }
        };

        function Remove() {
            let activeObjects = canvas.getActiveObjects();

            if (activeObjects?.length) {
                activeObjects.forEach(function (object) {
                    masForGroupUp.forEach((group, indMas) => {
                        group.forEach((innerEl, ind) => {
                            if (innerEl === object) {
                                let newGroup;
                                group[ind] = null;

                                newGroup = group.filter(el => el !== null);

                                masForGroupUp[indMas] = newGroup;
                            }
                        });
                    });

                    canvas.remove(object);
                });

                canvas.discardActiveObject();
            }
        }

        $('#objectWidth, #objectHeight').on('input',function(){
            let obj = canvas.getActiveObject();
            if ($(this).val()<0) {
                $(this).val(0);
            }

            if (obj) {
                switch ($(this).attr('id')) {
                    case 'objectWidth':
                        obj.set({
                            scaleX: $(this).val()/obj.width,
                        });
                        break;
                        case 'objectHeight':
                        obj.set({
                            scaleY: $(this).val()/obj.height,
                        });
                        break;
                    default:
                        break;
                }
                obj.setCoords();
                canvas.renderAll();
            }
        });
        $('.btns-number').on('click','button',function(){
            let attr = $(this).attr('name');
            let value = null;
            switch (attr) {
                case 'plus-w':
                    value=+$('#objectWidth').val() + 1;
                    $('#objectWidth').val(value);
                    $('#objectWidth').triggerHandler('input');
                    break;
                case 'plus-h':
                    value=+$('#objectHeight').val() + 1;
                    $('#objectHeight').val(value);
                    $('#objectHeight').triggerHandler('input');
                    break;
                case 'minus-w':
                    value=+$('#objectWidth').val() - 1;
                    $('#objectWidth').val(value);
                    $('#objectWidth').triggerHandler('input');
                    break;
                case 'minus-h':
                    value=+$('#objectHeight').val() - 1;
                    $('#objectHeight').val(value);
                    $('#objectHeight').triggerHandler('input');
                    break;
                case 'minus-fz':
                    value=+$('#textFontSize').val() - 1;
                    $('#textFontSize').val(value);
                    $('#textFontSize').triggerHandler('input');
                    break;
                case 'plus-fz':
                    value=+$('#textFontSize').val() + 1;
                    $('#textFontSize').val(value);
                    $('#textFontSize').triggerHandler('input');
                    break;
            
                default:
                    break;
            }
        });

        var observerForm1 = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutationRecord) {
                    if (mutationRecord.target.style.display === 'none') {
                        $('#rec387249820').hide();
                        return;
                    }
                    $('#rec387249789').hide();
                    $('#rec387249820').show();
                }); 
        });
        var triggerForm1 = document.querySelector('#rec387249789 #form387249789 .js-successbox');
        if (triggerForm1) {
            observerForm1.observe(triggerForm1, { attributes : true, attributeFilter : ['style'] });
        }

        function returnToWbForm(){
            $('#rec387249820').show();
            $('#our-demo').addClass('d-none');
        }

        // document.querySelector('#form387249820 button').addEventListener('click',function(e){
        //     let value = $('#form387249820 > div.t-container > div.t-col.t-col_8.t-prefix_2 > div.t186__wrapper > div.t186__blockinput > input').val();
        //     loadWBPhoto(value);
        // });

        $('#form387249820 .t-container').append($('.page-2 .mistake'));

        function setObjCoords(x, y){
            $('#coordX').val(x.toFixed());
            $('#coordY').val(y.toFixed());
        }

        document.onkeydown = function (event) {
            if (event.ctrlKey && event.key == 'z' || event.ctrlKey && event.key == 'я') {
                console.log('event: ', event);
                console.log(event.keyCode);
                // if (mods < state.length-1) {
                //     mods++;
                //     canvas.clear().renderAll();
                //     canvas.loadFromJSON(state[state.length - 1 - mods]);
                //     canvas.renderAll();
                //     masForGroupUp = [];
                //     is_edit_group = false;
                // }
            } else if (event.ctrlKey && event.key == 'y' || event.ctrlKey && event.key == 'н') {
                console.log('event: ', event);
                console.log(event.keyCode);
                // if (mods > 0) {
                //     mods--;
                //     canvas.clear().renderAll();
                //     canvas.loadFromJSON(state[state.length - 1 - mods]);
                //     canvas.renderAll();
                //     masForGroupUp = [];
                //     is_edit_group = false;
                // }
            }else  if (event.key === "Delete") {
                if (canvas.getActiveObject() && !canvas.getActiveObject().isEditing) {
                    Remove();
                }
            }
        };

        $("body").bind('copy', function() {
            Copy();
        });
        $("body").bind('paste', function() {
            Paste();
        });

        let _clipboard = null;

        function Copy() {
            canvas.getActiveObject().clone(function(cloned) {
                _clipboard = cloned;
            });
        }

        function Paste() {
            // clone again, so you can do multiple copies.
            _clipboard.clone(function(clonedObj) {
                canvas.discardActiveObject();
                
                clonedObj.set({
                    left: clonedObj.left + 10,
                    top: clonedObj.top + 10,
                    evented: true,
                });

                if (clonedObj.type === 'activeSelection') {
                    // active selection needs a reference to the canvas.
                    clonedObj.canvas = canvas;
                    clonedObj.forEachObject(function(obj) {
                        canvas.add(obj);
                    });
                    // this should solve the unselectability
                    clonedObj.setCoords();
                } else {
                    canvas.add(clonedObj);
                }
                _clipboard.top += 10;
                _clipboard.left += 10;
                canvas.setActiveObject(clonedObj);
                canvas.requestRenderAll();
            });
        }
    </script>
</body>

</html>